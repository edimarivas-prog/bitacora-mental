<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - Bitácora Mental</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* Estilos Maestros (Adaptados para Admin) */
    :root { 
      --primary: #1F2933; /* Oscuro para diferenciar del app de pacientes */
      --accent: #4F6F52; 
      --bg: #F3F4F6; 
      --white: #FFFFFF; 
      --text: #1F2933; 
      --border: #E5E7EB; 
      --radius: 16px; 
      --danger: #EF4444;
      --warning: #F59E0B;
      --success: #10B981;
    }
    
    * { box-sizing: border-box; }
    body { font-family: 'DM Sans', sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; min-height: 100vh; }
    
    /* Sidebar Admin */
    .sidebar { width: 260px; background: var(--primary); color: white; padding: 24px; position: sticky; top: 0; height: 100vh; display: flex; flex-direction: column; }
    .logo { font-family: 'Outfit'; font-weight: 700; color: white; font-size: 1.3rem; text-decoration: none; display: flex; align-items: center; gap: 10px; margin-bottom: 40px; padding-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); }
    
    .nav-section { margin-bottom: 25px; }
    .nav-title { font-size: 0.7rem; text-transform: uppercase; color: #94A3B8; font-weight: 700; padding-left: 12px; margin-bottom: 8px; letter-spacing: 1px; }
    .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px; color: #CBD5E1; text-decoration: none; border-radius: 12px; transition: 0.2s; font-size: 0.95rem; }
    .nav-item:hover, .nav-item.active { background: rgba(255,255,255,0.1); color: white; }
    .nav-item.active { border-left: 3px solid var(--accent); }
    
    /* Main Content */
    .main { flex: 1; padding: 30px 40px; overflow-y: auto; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
    .header h1 { font-family: 'Outfit'; font-size: 1.8rem; margin: 0; }
    .date-badge { background: white; padding: 8px 16px; border-radius: 20px; font-size: 0.9rem; color: #64748B; box-shadow: 0 2px 10px rgba(0,0,0,0.03); }

    /* Métricas */
    .metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 24px; margin-bottom: 30px; }
    .metric-card { background: white; padding: 24px; border-radius: var(--radius); box-shadow: 0 4px 6px rgba(0,0,0,0.02); display: flex; align-items: flex-start; justify-content: space-between; transition: transform 0.2s; }
    .metric-card:hover { transform: translateY(-3px); }
    .metric-info h3 { margin: 0 0 5px 0; color: #64748B; font-size: 0.9rem; font-weight: 500; }
    .metric-num { font-family: 'Outfit'; font-size: 2rem; font-weight: 700; color: var(--text); margin: 0; }
    .metric-icon { width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; }
    
    /* Alertas */
    .alert-box { background: #FEF2F2; border: 1px solid #FECACA; padding: 15px 20px; border-radius: 12px; display: flex; align-items: center; gap: 15px; color: #991B1B; margin-bottom: 30px; display: none; /* Se activa con JS */ }
    
    /* Quick Actions Grid */
    .actions-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 24px; }
    .panel { background: white; border-radius: var(--radius); padding: 25px; box-shadow: 0 4px 6px rgba(0,0,0,0.02); }
    .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .panel-title { font-family: 'Outfit'; font-weight: 600; font-size: 1.1rem; }
    
    .list-item { display: flex; align-items: center; gap: 15px; padding: 15px 0; border-bottom: 1px solid var(--bg); }
    .list-item:last-child { border-bottom: none; }
    .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; }
    .bg-orange { background: #FFEDD5; color: #9A3412; }

    @media (max-width: 900px) { .sidebar { display: none; } .actions-grid { grid-template-columns: 1fr; } }
  </style>
</head>
<body>

  <aside class="sidebar">
    <a href="#" class="logo"><i class="fas fa-brain"></i> ADMIN PRO</a>
    
    <div class="nav-section">
      <div class="nav-title">Resumen</div>
      <a href="panel-admin.html" class="nav-item active"><i class="fas fa-chart-pie"></i> Dashboard</a>
      <a href="monitoreo.html" class="nav-item"><i class="fas fa-desktop"></i> Monitoreo</a>
    </div>

    <div class="nav-section">
      <div class="nav-title">Gestión</div>
      <a href="verificacion.html" class="nav-item">
        <i class="fas fa-user-check"></i> Verificación
        <span id="badgePending" style="background:var(--danger); color:white; font-size:0.7rem; padding:2px 6px; border-radius:10px; margin-left:auto; display:none;">0</span>
      </a>
      <a href="gestion-usuarios.html" class="nav-item"><i class="fas fa-users-cog"></i> Usuarios</a>
    </div>

    <div class="nav-section">
      <div class="nav-title">Sistema</div>
      <a href="ajustes.html" class="nav-item"><i class="fas fa-sliders-h"></i> Ajustes Web</a>
    </div>

    <div style="margin-top:auto;">
      <a href="../app/dashboard.html" class="nav-item"><i class="fas fa-arrow-left"></i> Volver a la App</a>
      <a href="#" onclick="logout()" class="nav-item" style="color:#FCA5A5"><i class="fas fa-power-off"></i> Cerrar Sesión</a>
    </div>
  </aside>

  <main class="main">
    <div class="header">
      <div>
        <h1 id="adminName">Hola, Admin</h1>
        <p style="color:#64748B; margin:5px 0 0 0;">Aquí tienes el reporte de hoy.</p>
      </div>
      <div class="date-badge" id="currentDate">...</div>
    </div>

    <div id="alertVerification" class="alert-box">
      <i class="fas fa-exclamation-circle" style="font-size:1.5rem;"></i>
      <div style="flex:1">
        <strong>Atención requerida</strong><br>
        Hay <span id="countPendingAlert">0</span> psicólogos esperando validación de documentos.
      </div>
      <a href="verificacion.html" style="background:#B91C1C; color:white; text-decoration:none; padding:8px 15px; border-radius:8px; font-weight:600; font-size:0.9rem;">Revisar</a>
    </div>

    <div class="metrics-grid">
      <div class="metric-card">
        <div class="metric-info">
          <h3>Total Pacientes</h3>
          <p class="metric-num" id="statPacientes">-</p>
        </div>
        <div class="metric-icon" style="background:#E0F2FE; color:#0284C7"><i class="fas fa-users"></i></div>
      </div>

      <div class="metric-card">
        <div class="metric-info">
          <h3>Psicólogos Activos</h3>
          <p class="metric-num" id="statPsico">-</p>
        </div>
        <div class="metric-icon" style="background:#DCFCE7; color:#166534"><i class="fas fa-user-md"></i></div>
      </div>

      <div class="metric-card">
        <div class="metric-info">
          <h3>Citas Totales</h3>
          <p class="metric-num" id="statCitas">-</p>
        </div>
        <div class="metric-icon" style="background:#F3E8FF; color:#7E22CE"><i class="fas fa-calendar-check"></i></div>
      </div>

      <div class="metric-card">
        <div class="metric-info">
          <h3>Ingresos (Est.)</h3>
          <p class="metric-num">S/ <span id="statMoney">0</span></p>
        </div>
        <div class="metric-icon" style="background:#FEF3C7; color:#D97706"><i class="fas fa-wallet"></i></div>
      </div>
    </div>

    <div class="actions-grid">
      <div class="panel">
        <div class="panel-header">
          <div class="panel-title">Últimos Registros</div>
          <a href="gestion-usuarios.html" style="color:var(--accent); font-size:0.9rem; text-decoration:none;">Ver todos</a>
        </div>
        <div id="recentUsersList">Cargando...</div>
      </div>

      <div class="panel">
        <div class="panel-header"><div class="panel-title">Configuración Rápida</div></div>
        <div style="display:flex; flex-direction:column; gap:10px;">
          <button onclick="location.href='ajustes.html'" style="padding:15px; border:1px solid var(--border); background:white; border-radius:12px; cursor:pointer; text-align:left; display:flex; align-items:center; gap:10px; transition:0.2s;">
            <i class="fas fa-bullhorn" style="color:#64748B"></i> Cambiar Banner Home
          </button>
          <button onclick="location.href='gestion-usuarios.html'" style="padding:15px; border:1px solid var(--border); background:white; border-radius:12px; cursor:pointer; text-align:left; display:flex; align-items:center; gap:10px; transition:0.2s;">
            <i class="fas fa-ban" style="color:#EF4444"></i> Suspender Cuenta
          </button>
        </div>
      </div>
    </div>

  </main>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="../js/supabase-config.js"></script>
  <script>
    // 1. SEGURIDAD: Auth Guard Estricto
    async function checkAdmin() {
      if (!window.sb) return setTimeout(checkAdmin, 100);
      
      const { data: { session } } = await window.sb.auth.getSession();
      if (!session) return window.location.href = '../login.html';

      // Verificar ROL en DB
      const { data: profile } = await window.sb.from('users_profile').select('rol, nombre').eq('id', session.user.id).single();
      
      if (profile.rol !== 'admin') {
        alert("⛔ Acceso denegado: Área restringida.");
        window.location.href = '../app/dashboard.html';
      } else {
        document.getElementById('adminName').textContent = `Hola, ${profile.nombre.split(' ')[0]}`;
        initDashboard();
      }
    }
    checkAdmin();

    // 2. Cargar Métricas
    async function initDashboard() {
      // Fecha
      document.getElementById('currentDate').textContent = new Date().toLocaleDateString('es-PE', { weekday: 'long', day: 'numeric', month: 'long' });

      // Cargar contadores en paralelo para velocidad
      const [pacientes, psicos, citas, pendientes] = await Promise.all([
        window.sb.from('users_profile').select('*', { count: 'exact', head: true }).eq('rol', 'paciente'),
        window.sb.from('users_profile').select('*', { count: 'exact', head: true }).eq('rol', 'psicologo'),
        window.sb.from('citas').select('*', { count: 'exact', head: true }),
        window.sb.from('users_profile').select('*', { count: 'exact', head: true }).eq('rol', 'psicologo').eq('estado_validacion', 'pendiente')
      ]);

      // Renderizar números
      document.getElementById('statPacientes').textContent = pacientes.count || 0;
      document.getElementById('statPsico').textContent = psicos.count || 0;
      document.getElementById('statCitas').textContent = citas.count || 0;
      // Estimación simple: 50 soles por cita (ejemplo)
      document.getElementById('statMoney').textContent = (citas.count * 50).toFixed(2);

      // Alertas
      const pendingCount = pendientes.count || 0;
      if (pendingCount > 0) {
        document.getElementById('alertVerification').style.display = 'flex';
        document.getElementById('countPendingAlert').textContent = pendingCount;
        document.getElementById('badgePending').style.display = 'inline-block';
        document.getElementById('badgePending').textContent = pendingCount;
      }

      // Últimos Registros
      const { data: latest } = await window.sb.from('users_profile').select('*').order('created_at', { ascending: false }).limit(5);
      const list = document.getElementById('recentUsersList');
      list.innerHTML = latest.map(u => `
        <div class="list-item">
          <div style="width:40px; height:40px; background:#F3F4F6; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:700; color:#64748B;">
            ${(u.nombre || 'U').charAt(0)}
          </div>
          <div style="flex:1">
            <div style="font-weight:600; font-size:0.95rem;">${u.nombre || 'Usuario Nuevo'}</div>
            <div style="font-size:0.8rem; color:#94A3B8;">${new Date(u.created_at).toLocaleDateString()}</div>
          </div>
          <span class="status-badge" style="background:${u.rol === 'admin' ? '#FEF3C7' : '#F1F5F9'}; color:${u.rol === 'admin' ? '#92400E' : '#475569'}">
            ${u.rol}
          </span>
        </div>
      `).join('');
    }

    async function logout() { await window.sb.auth.signOut(); window.location.href = '../login.html'; }
  </script>
</body>
</html>
