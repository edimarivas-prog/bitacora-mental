<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mi Diario - Bit√°cora Mental</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    /* Estilos Base */
    :root {
      --primary: #4F6F52;
      --primary-light: #6B8A6E;
      --secondary: #A7C4B5;
      --background: #F9FBFA;
      --card-bg: #FFFFFF;
      --dark: #1F2933;
      --text-secondary: #6B7280;
      --border: #E6EFE8;
      --success: #10B981;
      --warning: #F59E0B;
      --danger: #EF4444;
      --radius: 16px;
      --shadow: 0 4px 20px rgba(0,0,0,0.06);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'DM Sans', sans-serif; background: var(--background); color: var(--dark); line-height: 1.6; }
    h1, h2, h3, h4 { font-family: 'Outfit', sans-serif; font-weight: 600; }

    .dashboard-container { display: grid; grid-template-columns: 260px 1fr; min-height: 100vh; }

    /* Sidebar */
    .sidebar { background: white; border-right: 1px solid var(--border); padding: 24px 0; position: sticky; top: 0; height: 100vh; display: flex; flex-direction: column; }
    .sidebar-header { padding: 0 24px 24px; border-bottom: 1px solid var(--border); }
    .logo { display: flex; align-items: center; gap: 12px; font-family: 'Outfit', sans-serif; font-weight: 700; font-size: 1.3rem; color: var(--primary); text-decoration: none; }
    .sidebar-nav { flex: 1; padding: 24px 0; overflow-y: auto; }
    .nav-section { margin-bottom: 24px; }
    .nav-section-title { font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-secondary); padding: 0 24px 8px; }
    .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 24px; color: var(--dark); text-decoration: none; transition: all 0.2s; border-left: 3px solid transparent; }
    .nav-item:hover { background: var(--background); color: var(--primary); }
    .nav-item.active { background: rgba(79, 111, 82, 0.08); color: var(--primary); border-left-color: var(--primary); font-weight: 600; }
    
    .sidebar-footer { padding: 0 24px; border-top: 1px solid var(--border); padding-top: 20px; margin-top: auto; }
    .user-profile { display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--background); border-radius: 12px; cursor: pointer; transition: all 0.2s; }
    .user-profile:hover { background: var(--border); }
    .user-avatar { width: 40px; height: 40px; background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 1rem; }
    .user-info { flex: 1; min-width: 0; }
    .user-name { font-weight: 600; font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .user-email { font-size: 0.75rem; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    /* Main Content */
    .main-content { padding: 32px 40px; max-width: 1600px; }
    .page-header { margin-bottom: 24px; }
    .page-header h1 { font-size: 2rem; margin-bottom: 8px; color: var(--dark); }
    .page-subtitle { color: var(--text-secondary); font-size: 1rem; }

    /* Layout Diario */
    .diary-layout { display: grid; grid-template-columns: 280px 1fr 340px; gap: 24px; align-items: start; }

    /* Left: Calendar */
    .calendar-sidebar { background: white; border-radius: var(--radius); padding: 24px; box-shadow: var(--shadow); position: sticky; top: 32px; }
    .mini-calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; font-weight: 600; }
    .mini-calendar-nav button { border: none; background: var(--background); border-radius: 6px; cursor: pointer; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
    .mini-calendar-nav button:hover { background: var(--primary); color: white; }
    .mini-calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
    .mini-calendar-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; font-size: 0.85rem; border-radius: 6px; cursor: pointer; transition: 0.2s; position: relative; }
    .mini-calendar-day.header { font-weight: 600; color: var(--text-secondary); cursor: default; }
    .mini-calendar-day:not(.header):not(.disabled):hover { background: var(--background); }
    .mini-calendar-day.selected { background: var(--primary); color: white; font-weight: 700; }
    .mini-calendar-day.today { border: 1px solid var(--primary); color: var(--primary); }
    /* Puntito indicador */
    .mini-calendar-day.has-entry::after { content: ''; position: absolute; bottom: 4px; width: 4px; height: 4px; background: var(--secondary); border-radius: 50%; }

    /* Center: Editor */
    .editor-container { background: white; border-radius: var(--radius); box-shadow: var(--shadow); padding: 40px; min-height: 70vh; display: flex; flex-direction: column; }
    
    .daily-quote { font-family: 'Outfit', sans-serif; color: var(--primary); font-size: 1.1rem; font-style: italic; text-align: center; margin-bottom: 30px; opacity: 0.8; }
    
    .editor-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-bottom: 20px; border-bottom: 1px solid var(--border); }
    .entry-date-display { font-size: 1.4rem; font-weight: 700; color: var(--dark); }
    .autosave-indicator { display: flex; align-items: center; gap: 8px; color: var(--text-secondary); font-size: 0.85rem; opacity: 0; transition: opacity 0.3s; }
    .autosave-indicator.visible { opacity: 1; }
    .autosave-indicator.saving { color: var(--warning); }
    .autosave-indicator.saved { color: var(--success); }
    .autosave-indicator.error { color: var(--danger); }
    
    .emotion-selector { margin-bottom: 24px; }
    .emotions-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(60px, 1fr)); gap: 10px; }
    .emotion-option { padding: 10px; border: 1px solid var(--border); border-radius: 12px; text-align: center; cursor: pointer; transition: 0.2s; opacity: 0.7; }
    .emotion-option:hover { transform: translateY(-3px); opacity: 1; border-color: var(--primary); }
    .emotion-option.selected { opacity: 1; background: rgba(79, 111, 82, 0.1); border-color: var(--primary); transform: scale(1.05); }
    .emotion-icon { font-size: 1.8rem; display: block; margin-bottom: 4px; }

    .text-editor { flex: 1; width: 100%; border: none; outline: none; font-size: 1.1rem; line-height: 1.8; font-family: 'DM Sans', sans-serif; resize: none; color: #4B5563; }
    .text-editor::placeholder { color: #9CA3AF; font-style: italic; }

    .btn { padding: 12px 24px; border-radius: 10px; font-weight: 600; border: none; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; transition: 0.3s; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-light); }

    /* Right: Tools & Therapy Notes */
    .tools-sidebar { display: flex; flex-direction: column; gap: 24px; position: sticky; top: 32px; }
    
    .therapy-notes-card { background: #FFFBF0; border: 1px solid #FDE68A; border-radius: var(--radius); padding: 24px; }
    .therapy-notes-header { display: flex; align-items: center; gap: 10px; margin-bottom: 16px; color: #92400E; }
    .therapy-input-group { display: flex; gap: 8px; margin-bottom: 16px; }
    .therapy-input { flex: 1; padding: 8px 12px; border: 1px solid #FCD34D; border-radius: 8px; font-family: 'DM Sans', sans-serif; }
    .btn-add-note { background: #F59E0B; color: white; border: none; border-radius: 8px; width: 36px; height: 36px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .therapy-list { list-style: none; padding: 0; margin: 0; max-height: 200px; overflow-y: auto; }
    .therapy-item { background: white; padding: 10px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: flex-start; font-size: 0.9rem; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
    .btn-delete-note { background: none; border: none; color: #EF4444; cursor: pointer; opacity: 0.6; }
    .btn-delete-note:hover { opacity: 1; }

    .prompts-card { background: white; border-radius: var(--radius); padding: 24px; box-shadow: var(--shadow); }
    .prompt-item { padding: 12px; background: var(--background); border-radius: 8px; margin-bottom: 8px; cursor: pointer; font-size: 0.9rem; transition: 0.2s; border-left: 3px solid transparent; line-height: 1.4; }
    .prompt-item:hover { border-left-color: var(--primary); background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .prompt-item strong { color: var(--primary); display: block; font-size: 0.8rem; margin-bottom: 4px; text-transform: uppercase; }

    /* Modal Resumen */
    .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
    .modal.active { display: flex; }
    .summary-paper { background: white; padding: 40px; width: 100%; max-width: 500px; border-radius: 4px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); position: relative; background-image: linear-gradient(#F3F4F6 1px, transparent 1px); background-size: 100% 30px; line-height: 30px; }
    .paper-holes { position: absolute; left: 15px; top: 40px; bottom: 40px; display: flex; flex-direction: column; justify-content: space-between; }
    .hole { width: 15px; height: 15px; background: #E5E7EB; border-radius: 50%; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1); }
    .summary-content { margin-left: 30px; font-family: 'DM Sans', cursive; }
    .checklist-item { display: flex; align-items: center; gap: 10px; margin-bottom: 5px; }
    .checklist-box { width: 18px; height: 18px; border: 2px solid var(--dark); border-radius: 4px; }

    @media (max-width: 1200px) { .diary-layout { grid-template-columns: 1fr; } .calendar-sidebar, .tools-sidebar { position: static; } }
    @media (max-width: 968px) { .dashboard-container { grid-template-columns: 1fr; } .sidebar { display: none; } }
  </style>
</head>
<body>
  <div class="dashboard-container">
    <aside class="sidebar">
      <div class="sidebar-header">
        <a href="dashboard.html" class="logo"><i class="fas fa-brain"></i> Bit√°cora Mental</a>
      </div>
      <nav class="sidebar-nav">
        <div class="nav-section">
          <div class="nav-section-title">Principal</div>
          <a href="dashboard.html" class="nav-item"><i class="fas fa-home"></i> <span>Dashboard</span></a>
          <a href="citas.html" class="nav-item"><i class="fas fa-calendar-alt"></i> <span>Mis Citas</span></a>
          <a href="especialistas.html" class="nav-item"><i class="fas fa-user-md"></i> <span>Especialistas</span></a>
        </div>
        <div class="nav-section">
          <div class="nav-section-title">Mi Espacio</div>
          <a href="diario.html" class="nav-item active"><i class="fas fa-book"></i> <span>Mi Diario</span></a>
          <a href="progreso.html" class="nav-item"><i class="fas fa-chart-line"></i> <span>Mi Progreso</span></a>
          <a href="recursos.html" class="nav-item"><i class="fas fa-folder-open"></i> <span>Recursos</span></a>
        </div>
        <div class="nav-section">
          <div class="nav-section-title">Cuenta</div>
          <a href="plan.html" class="nav-item"><i class="fas fa-crown"></i> <span>Mi Plan</span></a>
          <a href="perfil.html" class="nav-item"><i class="fas fa-user-circle"></i> <span>Perfil</span></a>
          <a href="#" class="nav-item" onclick="handleLogout()"><i class="fas fa-sign-out-alt"></i> <span>Cerrar Sesi√≥n</span></a>
          <a href="configuracion.html" class="nav-item"><i class="fas fa-cog"></i> <span>Configuraci√≥n</span></a>
        </div>
      </nav>
      <div class="sidebar-footer">
        <div class="user-profile">
          <div class="user-avatar" id="avatarInitials">--</div>
          <div class="user-info">
            <div class="user-name" id="sidebarUserName">Cargando...</div>
            <div class="user-email" id="sidebarUserEmail">...</div>
          </div>
        </div>
      </div>
    </aside>

    <main class="main-content">
      <div class="page-header">
        <h1>Mi Diario Personal</h1>
        <p class="page-subtitle">Un espacio seguro para soltar, reflexionar y crecer.</p>
      </div>

      <div class="diary-layout">
        <div class="calendar-sidebar">
          <div class="mini-calendar-header">
            <span id="calendarMonthYear"></span>
            <div class="mini-calendar-nav">
              <button onclick="prevMonth()"><i class="fas fa-chevron-left"></i></button>
              <button onclick="nextMonth()"><i class="fas fa-chevron-right"></i></button>
            </div>
          </div>
          <div class="mini-calendar-grid" id="miniCalendar"></div>
        </div>

        <div class="editor-container">
          <div class="daily-quote" id="dailyQuote">"Cargando inspiraci√≥n..."</div>
          
          <div class="editor-header">
            <div class="entry-date-display" id="entryDate">Hoy</div>
            <div class="autosave-indicator" id="saveStatus"></div>
          </div>

          <div class="emotion-selector">
            <label style="display:block; margin-bottom:10px; font-weight:600; color:var(--text-secondary)">¬øC√≥mo te sientes en este momento?</label>
            <div class="emotions-grid">
              <div class="emotion-option" onclick="setEmotion('feliz')"><span class="emotion-icon">üòä</span>Feliz</div>
              <div class="emotion-option" onclick="setEmotion('tranquilo')"><span class="emotion-icon">üòå</span>Calma</div>
              <div class="emotion-option" onclick="setEmotion('triste')"><span class="emotion-icon">üòî</span>Triste</div>
              <div class="emotion-option" onclick="setEmotion('ansioso')"><span class="emotion-icon">üò∞</span>Ansiedad</div>
              <div class="emotion-option" onclick="setEmotion('enojado')"><span class="emotion-icon">üò†</span>Enojo</div>
            </div>
          </div>

          <textarea class="text-editor" id="diaryContent" placeholder="Hola... ¬øqu√© tal estuvo tu d√≠a hoy? Si√©ntete libre de escribir cualquier cosa que pase por tu mente..."></textarea>

          <div style="margin-top: auto; padding-top: 20px; display: flex; justify-content: space-between;">
            <button class="btn btn-primary" onclick="saveEntry()"><i class="fas fa-save"></i> Guardar entrada</button>
          </div>
        </div>

        <div class="tools-sidebar">
          
          <div class="therapy-notes-card">
            <div class="therapy-notes-header">
              <i class="fas fa-user-md" style="font-size: 1.2rem;"></i>
              <h3 style="font-size: 1.1rem; margin:0;">Para mi pr√≥xima sesi√≥n</h3>
            </div>
            <p style="font-size: 0.85rem; color: #B45309; margin-bottom: 12px;">Anota temas clave para no olvidarlos.</p>
            
            <div class="therapy-input-group">
              <input type="text" id="therapyNoteInput" class="therapy-input" placeholder="Ej: Hablar sobre mi sue√±o...">
              <button class="btn-add-note" onclick="addTherapyNote()"><i class="fas fa-plus"></i></button>
            </div>

            <ul class="therapy-list" id="therapyList"></ul>

            <button class="btn" style="width: 100%; margin-top: 15px; background: white; border: 1px solid #F59E0B; color: #F59E0B; font-size: 0.9rem;" onclick="openSummaryModal()">
              <i class="fas fa-list-check"></i> Ver Resumen / Checklist
            </button>
          </div>

          <div class="prompts-card">
            <h3 style="font-size: 1.1rem; margin-bottom: 15px;">
              <i class="fas fa-lightbulb" style="color: var(--warning)"></i> Ideas para escribir
            </h3>
            
            <div id="promptsContainer"></div>
            
            <button onclick="renderPrompts()" style="background:none; border:none; color:var(--primary); font-size:0.8rem; cursor:pointer; margin-top:10px; text-decoration:underline;">
              <i class="fas fa-sync-alt"></i> Cambiar ideas
            </button>
          </div>
        </div>
      </div>
    </main>
  </div>

  <div class="modal" id="summaryModal">
    <div class="summary-paper">
      <div class="paper-holes">
        <div class="hole"></div><div class="hole"></div><div class="hole"></div>
      </div>
      <div style="text-align: right; margin-bottom: 20px;">
        <button onclick="closeSummaryModal()" style="border:none; background:none; cursor:pointer; font-size:1.2rem; color: #9CA3AF;"><i class="fas fa-times"></i></button>
      </div>
      <h2 style="font-family: 'Outfit'; color: var(--dark); margin-bottom: 20px; text-align: center;">üìù Temas para mi sesi√≥n</h2>
      <div class="summary-content" id="summaryContent"></div>
      <p style="text-align: center; margin-top: 30px; font-size: 0.8rem; color: #9CA3AF;">Bit√°cora Mental - Resumen Personal</p>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="../js/supabase-config.js"></script>

  <script>
    // --- VARIABLES GLOBALES ---
    let currentDate = new Date();
    let selectedDate = new Date();
    let currentEntryId = null;
    let currentEmotion = null;
    let existingDates = new Set();
    let therapyNotes = JSON.parse(localStorage.getItem('therapyNotes')) || [];
    
    // Frases aleatorias (Header)
    const quotes = [
      "No tienes que poder con todo hoy.",
      "Tus sentimientos son v√°lidos.",
      "Un d√≠a a la vez.",
      "Lo est√°s haciendo mejor de lo que crees.",
      "Respirar es el primer paso para calmarse.",
      "Eres suficiente tal como eres.",
      "El descanso tambi√©n es productivo."
    ];
    document.getElementById('dailyQuote').innerText = `"${quotes[Math.floor(Math.random() * quotes.length)]}"`;

    // --- BANCO DE IDEAS (PROMPTS) ---
    const allPrompts = [
      { text: "Hoy me sent√≠ orgulloso de m√≠ mismo cuando...", label: "Orgullo personal" },
      { text: "Algo que me est√° costando soltar es...", label: "Desahogo" },
      { text: "Tres cosas por las que agradezco hoy:", label: "Gratitud" },
      { text: "¬øQu√© le dir√≠a a mi yo de hace 5 a√±os?", label: "Reflexi√≥n" },
      { text: "Una peque√±a victoria de hoy fue...", label: "Logros" },
      { text: "Hoy cuid√© de m√≠ mismo al...", label: "Autocuidado" },
      { text: "¬øQu√© necesito escuchar en este momento?", label: "Compasi√≥n" },
      { text: "Si no tuviera miedo, hoy hubiera...", label: "Valent√≠a" },
      { text: "La emoci√≥n m√°s fuerte que sent√≠ hoy fue...", label: "Emociones" },
      { text: "Una meta realista para ma√±ana es...", label: "Futuro" },
      { text: "¬øQu√© me quit√≥ energ√≠a hoy y c√≥mo puedo recuperarla?", label: "Energ√≠a" },
      { text: "Una persona que hizo mi d√≠a mejor hoy...", label: "Conexi√≥n" },
      { text: "Mi cuerpo me est√° pidiendo...", label: "Cuerpo" },
      { text: "Un l√≠mite saludable que puse (o deb√≠ poner) hoy...", label: "L√≠mites" }
    ];

    // --- INICIALIZACI√ìN ---
    async function init() {
        const { data: { user } } = await window.supabase.auth.getUser();
        if (!user) { window.location.href = '../login.html'; return; }

        const { data: profile } = await window.supabase.from('users_profile').select('*').eq('id', user.id).single();
        if (profile) {
            document.getElementById('sidebarUserName').textContent = `${profile.nombre} ${profile.apellido}`;
            document.getElementById('sidebarUserEmail').textContent = user.email;
            document.getElementById('avatarInitials').textContent = (profile.nombre[0] + profile.apellido[0]).toUpperCase();
        }

        await loadEntryDates(user.id);
        renderCalendar();
        renderTherapyNotes();
        renderPrompts();
        loadEntryForDate(new Date());
    }

    // --- L√ìGICA DEL DIARIO ---
    async function loadEntryDates(userId) {
        const { data } = await window.supabase.from('diario_emocional').select('fecha').eq('user_id', userId);
        if (data) {
            existingDates.clear();
            data.forEach(entry => existingDates.add(new Date(entry.fecha).toISOString().split('T')[0]));
            renderCalendar();
        }
    }

    async function loadEntryForDate(date) {
        selectedDate = date; 
        updateHeaderDate(date);
        const { data: { user } } = await window.supabase.auth.getUser();
        
        const startOfDay = new Date(date); startOfDay.setHours(0,0,0,0);
        const endOfDay = new Date(date); endOfDay.setHours(23,59,59,999);
        
        document.getElementById('diaryContent').value = "Cargando...";
        
        const { data } = await window.supabase.from('diario_emocional')
            .select('*')
            .eq('user_id', user.id)
            .gte('fecha', startOfDay.toISOString())
            .lte('fecha', endOfDay.toISOString())
            .order('created_at', { ascending: false })
            .limit(1);

        if (data && data.length > 0) {
            const entry = data[0];
            currentEntryId = entry.id;
            document.getElementById('diaryContent').value = entry.contenido || "";
            setEmotionUI(entry.emocion);
            updateSaveStatus('Cargado', 'saved');
        } else {
            currentEntryId = null;
            document.getElementById('diaryContent').value = "";
            setEmotionUI(null);
            updateSaveStatus('', '');
        }
    }

    async function saveEntry() {
        const content = document.getElementById('diaryContent').value;
        if (!content.trim()) return;
        
        updateSaveStatus('Guardando...', 'saving');
        const { data: { user } } = await window.supabase.auth.getUser();
        
        const saveDate = new Date(selectedDate);
        const now = new Date();
        saveDate.setHours(now.getHours(), now.getMinutes(), now.getSeconds());

        let result;
        if (currentEntryId) {
            result = await window.supabase.from('diario_emocional')
                .update({ contenido: content, emocion: currentEmotion })
                .eq('id', currentEntryId);
        } else {
            result = await window.supabase.from('diario_emocional')
                .insert({ user_id: user.id, fecha: saveDate.toISOString(), contenido: content, emocion: currentEmotion })
                .select();
                
            if (result.data) {
                currentEntryId = result.data[0].id;
                existingDates.add(saveDate.toISOString().split('T')[0]);
                renderCalendar();
            }
        }

        if (result.error) {
            console.error(result.error);
            updateSaveStatus('Error', 'error');
            alert('Error al guardar: ' + result.error.message);
        } else {
            updateSaveStatus('Guardado', 'saved');
        }
    }

    // --- PROMPTS ALEATORIOS ---
    function renderPrompts() {
      const container = document.getElementById('promptsContainer');
      container.innerHTML = '';
      
      const shuffled = allPrompts.sort(() => 0.5 - Math.random());
      const selected = shuffled.slice(0, 3);

      selected.forEach(prompt => {
        const div = document.createElement('div');
        div.className = 'prompt-item';
        div.innerHTML = `<strong>${prompt.label}:</strong> ${prompt.text.substring(0, 25)}...`;
        div.onclick = () => usePrompt(prompt.text);
        container.appendChild(div);
      });
    }

    function usePrompt(text) {
        const editor = document.getElementById('diaryContent');
        editor.value += (editor.value ? '\n\n' : '') + text + '\n';
        editor.focus();
        editor.scrollTop = editor.scrollHeight;
    }

    // --- CALENDARIO UI ---
    function renderCalendar() {
        const grid = document.getElementById('miniCalendar');
        const monthYear = document.getElementById('calendarMonthYear');
        const months = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
        monthYear.innerText = `${months[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
        
        const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1).getDay();
        const daysInMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getDate();
        
        let html = '';
        ['D','L','M','M','J','V','S'].forEach(d => html += `<div class="mini-calendar-day header">${d}</div>`);

        for(let i=0; i<firstDay; i++) html += `<div></div>`;

        for(let i=1; i<=daysInMonth; i++) {
            const year = currentDate.getFullYear();
            const month = String(currentDate.getMonth() + 1).padStart(2, '0');
            const dayStr = String(i).padStart(2, '0');
            const dateKey = `${year}-${month}-${dayStr}`;

            const isToday = i === new Date().getDate() && currentDate.getMonth() === new Date().getMonth() && currentDate.getFullYear() === new Date().getFullYear();
            const isSelected = i === selectedDate.getDate() && currentDate.getMonth() === selectedDate.getMonth();
            const hasEntry = existingDates.has(dateKey);

            html += `<div class="mini-calendar-day ${isToday ? 'today' : ''} ${isSelected ? 'selected' : ''} ${hasEntry ? 'has-entry' : ''}" 
                     onclick="selectDate(${i})">${i}</div>`;
        }
        grid.innerHTML = html;
    }

    function selectDate(day) {
        const newDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
        loadEntryForDate(newDate);
        renderCalendar();
    }

    // --- UI HELPERS ---
    function setEmotion(emotionName) { currentEmotion = emotionName; setEmotionUI(emotionName); }
    function setEmotionUI(emotionName) {
        document.querySelectorAll('.emotion-option').forEach(el => el.classList.remove('selected'));
        if (emotionName) {
            const map = { 'feliz': 0, 'tranquilo': 1, 'triste': 2, 'ansioso': 3, 'enojado': 4 };
            if (map[emotionName] !== undefined) document.querySelectorAll('.emotion-option')[map[emotionName]].classList.add('selected');
        }
    }
    function updateHeaderDate(date) { document.getElementById('entryDate').textContent = date.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }); }
    function updateSaveStatus(text, type) {
        const el = document.getElementById('saveStatus');
        el.className = `autosave-indicator visible ${type}`;
        el.innerHTML = type === 'saving' ? '<i class="fas fa-spinner fa-spin"></i> ' + text : (type === 'saved' ? '<i class="fas fa-check-circle"></i> ' + text : text);
    }
    function prevMonth() { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); }
    function nextMonth() { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); }

    // --- NOTAS TERAP√âUTICAS ---
    function addTherapyNote() {
        const input = document.getElementById('therapyNoteInput');
        const text = input.value.trim();
        if (text) { therapyNotes.push({ id: Date.now(), text: text }); localStorage.setItem('therapyNotes', JSON.stringify(therapyNotes)); input.value = ''; renderTherapyNotes(); }
    }
    function deleteNote(id) { therapyNotes = therapyNotes.filter(n => n.id !== id); localStorage.setItem('therapyNotes', JSON.stringify(therapyNotes)); renderTherapyNotes(); }
    function renderTherapyNotes() {
        const list = document.getElementById('therapyList');
        if (therapyNotes.length === 0) { list.innerHTML = '<li style="color:#B45309; opacity:0.7; font-size:0.85rem; text-align:center; padding:10px;">Sin notas a√∫n.</li>'; return; }
        list.innerHTML = therapyNotes.map(note => `<li class="therapy-item"><span>${note.text}</span><button class="btn-delete-note" onclick="deleteNote(${note.id})"><i class="fas fa-trash-alt"></i></button></li>`).join('');
    }
    function openSummaryModal() {
        const container = document.getElementById('summaryContent');
        if(therapyNotes.length === 0) { container.innerHTML = "<p>No tienes notas pendientes para tu sesi√≥n.</p>"; } 
        else { container.innerHTML = therapyNotes.map(n => `<div class="checklist-item"><div class="checklist-box"></div><span>${n.text}</span></div>`).join(''); }
        document.getElementById('summaryModal').classList.add('active');
    }
    function closeSummaryModal() { document.getElementById('summaryModal').classList.remove('active'); }
    async function handleLogout() { await window.supabase.auth.signOut(); window.location.href = '../login.html'; }

    // Iniciar
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
