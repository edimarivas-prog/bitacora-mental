<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mis Citas - Bitácora Mental</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700&family=DM+Sans:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root { --primary: #4F6F52; --bg: #F3F6F4; --white: #fff; --text: #1F2933; --border: #E6EFE8; --radius: 20px; }
    body { font-family: 'DM Sans', sans-serif; background: var(--bg); margin: 0; display: flex; }
    .sidebar { width: 260px; background: white; padding: 24px; border-right: 1px solid var(--border); position: fixed; height: 100%; top: 0; z-index: 100; }
    .main { flex: 1; padding: 30px; margin-left: 260px; }
    
    .tabs { display: flex; gap: 15px; margin-bottom: 25px; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
    .tab { background: none; border: none; font-size: 1rem; color: #64748B; cursor: pointer; padding: 5px 10px; font-weight: 600; }
    .tab.active { color: var(--primary); border-bottom: 2px solid var(--primary); }
    
    .cita-card { background: white; padding: 20px; border-radius: var(--radius); box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; border-left: 5px solid var(--primary); }
    .cita-info h3 { margin: 0 0 5px 0; font-family: 'Outfit'; }
    .cita-info p { margin: 0; color: #64748B; font-size: 0.9rem; }
    .btn { padding: 10px 20px; border-radius: 12px; text-decoration: none; font-weight: 600; font-size: 0.9rem; border: none; cursor: pointer; transition: 0.2s; }
    .btn-join { background: var(--primary); color: white; }
    .btn-cancel { background: #fee2e2; color: #dc2626; }
    
    @media (max-width: 900px) { .sidebar { display: none; } .main { margin-left: 0; padding: 20px; } }
  </style>
</head>
<body>
  <aside class="sidebar">
    <a href="dashboard.html" style="font-family:'Outfit'; font-weight:700; color:var(--primary); font-size:1.3rem; margin-bottom:30px; text-decoration:none;"><i class="fas fa-brain"></i> Bitácora</a>
    <nav style="display:flex; flex-direction:column; gap:5px;">
        <a href="dashboard.html" style="padding:12px; color:#64748B; text-decoration:none;"><i class="fas fa-home"></i> Inicio</a>
        <a href="diario.html" style="padding:12px; color:#64748B; text-decoration:none;"><i class="fas fa-book"></i> Diario</a>
        <a href="citas.html" style="padding:12px; background:#E8F5E9; color:var(--primary); font-weight:600; border-radius:12px; text-decoration:none;"><i class="fas fa-calendar-alt"></i> Citas</a>
        <a href="recursos.html" style="padding:12px; color:#64748B; text-decoration:none;"><i class="fas fa-box-open"></i> Recursos</a>
    </nav>
  </aside>

  <main class="main">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
        <h1 style="font-family:'Outfit'; margin:0;">Mis Citas</h1>
        <a href="agendar.html" class="btn btn-join"><i class="fas fa-plus"></i> Nueva Cita</a>
    </div>

    <div class="tabs">
        <button class="tab active" onclick="filterCitas('proxima')">Próximas</button>
        <button class="tab" onclick="filterCitas('historial')">Historial</button>
    </div>

    <div id="citasContainer">Cargando...</div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="../js/supabase-config.js"></script>
  <script>
    let allCitas = [];

    async function checkAuth() {
        if (!window.sb) { setTimeout(checkAuth, 100); return; }
        const { data: { session } } = await window.sb.auth.getSession();
        if (!session) window.location.replace('../login.html');
        else loadCitas(session.user.id);
    }
    checkAuth();

    async function loadCitas(userId) {
        // Obtenemos citas con datos del psicólogo
        const { data } = await window.sb.from('citas')
            .select('*, psicologos(nombre_completo)')
            .eq('paciente_id', userId)
            .order('fecha_hora', { ascending: true });
        
        allCitas = data || [];
        filterCitas('proxima');
    }

    function filterCitas(tipo) {
        const container = document.getElementById('citasContainer');
        container.innerHTML = '';
        
        const now = new Date();
        const filtered = allCitas.filter(c => {
            const d = new Date(c.fecha_hora);
            return tipo === 'proxima' ? (d >= now && c.estado === 'agendada') : (d < now || c.estado !== 'agendada');
        });

        if (filtered.length === 0) {
            container.innerHTML = '<p style="color:#666">No hay citas en esta sección.</p>';
            return;
        }

        filtered.forEach(c => {
            const date = new Date(c.fecha_hora);
            const div = document.createElement('div');
            div.className = 'cita-card';
            div.innerHTML = `
                <div class="cita-info">
                    <h3>${c.psicologos?.nombre_completo || 'Especialista'}</h3>
                    <p><i class="far fa-clock"></i> ${date.toLocaleDateString('es-PE')} - ${date.toLocaleTimeString('es-PE', {hour:'2-digit', minute:'2-digit'})}</p>
                    <p style="color:var(--primary); font-weight:600; font-size:0.8rem; margin-top:5px;">${c.estado.toUpperCase()}</p>
                </div>
                <div>
                    ${c.link_videollamada ? `<a href="${c.link_videollamada}" target="_blank" class="btn btn-join">Unirse</a>` : ''}
                    ${tipo === 'proxima' ? `<button onclick="cancelCita(${c.id})" class="btn btn-cancel">Cancelar</button>` : ''}
                </div>
            `;
            container.appendChild(div);
        });
    }

    async function cancelCita(id) {
        if(!confirm('¿Seguro que deseas cancelar?')) return;
        await window.sb.from('citas').update({ estado: 'cancelada' }).eq('id', id);
        location.reload();
    }
  </script>
</body>
</html>
