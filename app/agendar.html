<main class="main">
  <h1>Agendar Sesión</h1>
  <div class="card">
    <div style="margin-bottom: 20px;">
        <label style="display:block; font-weight:600; margin-bottom:8px;">Selecciona una fecha</label>
        <input type="date" id="datePicker" class="nav-item" style="width:100%; border:1px solid #ccc;">
    </div>
    
    <div id="slots" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap:10px;">
        </div>
  </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="../js/supabase-config.js"></script>
<script>
    // Configuración Perú
    const PERU_OFFSET = -5; 

    async function checkAuth() {
        if (!window.sb) { setTimeout(checkAuth, 100); return; }
        const { data: { session } } = await window.sb.auth.getSession();
        if (!session) window.location.replace('../login.html');
        initPicker();
    }
    checkAuth();

    function initPicker() {
        const input = document.getElementById('datePicker');
        
        // 1. Restricción: No fechas pasadas (Usando hora Perú)
        const now = new Date();
        // Ajuste manual a hora Perú si el usuario está en otra zona
        const peruTime = new Date(now.getTime() + (now.getTimezoneOffset() * 60000) + (3600000 * PERU_OFFSET));
        
        const yyyy = peruTime.getFullYear();
        const mm = String(peruTime.getMonth() + 1).padStart(2, '0');
        const dd = String(peruTime.getDate()).padStart(2, '0');
        
        input.min = `${yyyy}-${mm}-${dd}`;
        
        input.addEventListener('change', loadSlots);
    }

    async function loadSlots() {
        const dateVal = document.getElementById('datePicker').value;
        if (!dateVal) return;

        const container = document.getElementById('slots');
        container.innerHTML = 'Cargando...';

        // Horarios fijos (Ejemplo)
        const hours = ['09:00', '10:00', '11:00', '15:00', '16:00', '17:00'];
        
        container.innerHTML = hours.map(time => `
            <button onclick="book('${dateVal}', '${time}')" 
                    style="padding:10px; border-radius:10px; border:1px solid #ddd; background:white; cursor:pointer;">
                ${time}
            </button>
        `).join('');
    }

    async function book(date, time) {
        if(!confirm(`¿Confirmar cita para el ${date} a las ${time}?`)) return;
        
        const { data: { user } } = await window.sb.auth.getUser();
        
        // Guardar en Supabase (Tabla citas)
        const { error } = await window.sb.from('citas').insert({
            paciente_id: user.id,
            fecha_hora: `${date}T${time}:00`, // Formato ISO simple
            estado: 'agendada'
        });

        if (error) alert("Error: " + error.message);
        else {
            alert("¡Cita agendada!");
            window.location.href = 'citas.html';
        }
    }
</script>
