<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mi Progreso - Bitácora Mental</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  
  <style>
    /* Estilos Base */
    :root {
      --primary: #4F6F52;
      --primary-light: #6B8A6E;
      --secondary: #A7C4B5;
      --background: #F9FBFA;
      --card-bg: #FFFFFF;
      --dark: #1F2933;
      --text-secondary: #6B7280;
      --border: #E6EFE8;
      --success: #10B981;
      --warning: #F59E0B;
      --danger: #EF4444;
      --radius: 16px;
      --shadow: 0 4px 20px rgba(0,0,0,0.06);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'DM Sans', sans-serif; background: var(--background); color: var(--dark); line-height: 1.6; }
    h1, h2, h3, h4 { font-family: 'Outfit', sans-serif; font-weight: 600; }

    .dashboard-container { display: grid; grid-template-columns: 260px 1fr; min-height: 100vh; }

    /* Sidebar Estandarizado */
    .sidebar { background: white; border-right: 1px solid var(--border); padding: 24px 0; position: sticky; top: 0; height: 100vh; display: flex; flex-direction: column; }
    .sidebar-header { padding: 0 24px 24px; border-bottom: 1px solid var(--border); }
    .logo { display: flex; align-items: center; gap: 12px; font-family: 'Outfit', sans-serif; font-weight: 700; font-size: 1.3rem; color: var(--primary); text-decoration: none; }
    .sidebar-nav { flex: 1; padding: 24px 0; overflow-y: auto; }
    .nav-section { margin-bottom: 24px; }
    .nav-section-title { font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-secondary); padding: 0 24px 8px; }
    .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 24px; color: var(--dark); text-decoration: none; transition: all 0.2s; border-left: 3px solid transparent; }
    .nav-item:hover { background: var(--background); color: var(--primary); }
    .nav-item.active { background: rgba(79, 111, 82, 0.08); color: var(--primary); border-left-color: var(--primary); font-weight: 600; }
    
    .sidebar-footer { padding: 0 24px; border-top: 1px solid var(--border); padding-top: 20px; margin-top: auto; }
    .user-profile { display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--background); border-radius: 12px; cursor: pointer; transition: all 0.2s; }
    .user-profile:hover { background: var(--border); }
    .user-avatar { width: 40px; height: 40px; background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 1rem; }
    .user-info { flex: 1; min-width: 0; }
    .user-name { font-weight: 600; font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .user-email { font-size: 0.75rem; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    /* Main Content */
    .main-content { padding: 32px 40px; max-width: 1400px; }
    .page-header { margin-bottom: 32px; }
    .page-header h1 { font-size: 2rem; margin-bottom: 8px; color: var(--dark); }
    .page-subtitle { color: var(--text-secondary); font-size: 1rem; }

    /* Charts Grid */
    .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 24px; margin-bottom: 32px; }
    .chart-card { background: white; border-radius: 16px; padding: 28px; box-shadow: 0 4px 20px rgba(0,0,0,0.06); }
    .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
    .chart-title { font-size: 1.2rem; font-weight: 600; }
    .chart-subtitle { color: var(--text-secondary); font-size: 0.9rem; margin-top: 4px; }
    .chart-container { position: relative; height: 300px; }

    /* Test History */
    .test-history { background: white; border-radius: 16px; padding: 28px; box-shadow: 0 4px 20px rgba(0,0,0,0.06); margin-bottom: 32px; }
    .test-item { display: flex; gap: 20px; padding: 20px; border-radius: 12px; background: var(--background); margin-bottom: 16px; transition: all 0.2s; }
    .test-item:hover { background: var(--border); }
    .test-date-badge { flex-shrink: 0; width: 60px; text-align: center; }
    .test-day { font-size: 1.8rem; font-weight: 700; color: var(--primary); }
    .test-month { font-size: 0.85rem; color: var(--text-secondary); text-transform: uppercase; }
    .test-content { flex: 1; }
    .test-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 8px; }
    .test-scores { display: flex; gap: 16px; flex-wrap: wrap; }
    .score-badge { padding: 6px 12px; border-radius: 8px; font-size: 0.85rem; font-weight: 600; }
    .score-badge.low { background: rgba(16, 185, 129, 0.1); color: var(--success); }
    .score-badge.medium { background: rgba(245, 158, 11, 0.1); color: var(--warning); }
    .score-badge.high { background: rgba(239, 68, 68, 0.1); color: var(--danger); }

    /* Insights Grid */
    .insights-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
    .insight-card { background: white; border-radius: 16px; padding: 24px; box-shadow: 0 4px 20px rgba(0,0,0,0.06); border-left: 4px solid var(--primary); }
    .insight-icon { width: 40px; height: 40px; border-radius: 10px; background: rgba(79, 111, 82, 0.1); color: var(--primary); display: flex; align-items: center; justify-content: center; margin-bottom: 16px; font-size: 1.3rem; }
    .insight-title { font-size: 1rem; font-weight: 600; margin-bottom: 8px; }
    .insight-text { color: var(--text-secondary); font-size: 0.9rem; line-height: 1.6; }

    @media (max-width: 968px) {
      .dashboard-container { grid-template-columns: 1fr; }
      .sidebar { display: none; }
      .main-content { padding: 20px; }
      .charts-grid { grid-template-columns: 1fr; }
      .test-item { flex-direction: column; }
    }
  </style>
</head>
<body>
  <div class="dashboard-container">
    <aside class="sidebar">
      <div class="sidebar-header">
        <a href="dashboard.html" class="logo"><i class="fas fa-brain"></i> Bitácora Mental</a>
      </div>
      <nav class="sidebar-nav">
        <div class="nav-section">
          <div class="nav-section-title">Principal</div>
          <a href="dashboard.html" class="nav-item"><i class="fas fa-home"></i> <span>Dashboard</span></a>
          <a href="citas.html" class="nav-item"><i class="fas fa-calendar-alt"></i> <span>Mis Citas</span></a>
          <a href="especialistas.html" class="nav-item"><i class="fas fa-user-md"></i> <span>Especialistas</span></a>
        </div>
        <div class="nav-section">
          <div class="nav-section-title">Mi Espacio</div>
          <a href="diario.html" class="nav-item"><i class="fas fa-book"></i> <span>Mi Diario</span></a>
          <a href="progreso.html" class="nav-item active"><i class="fas fa-chart-line"></i> <span>Mi Progreso</span></a>
          <a href="recursos.html" class="nav-item"><i class="fas fa-folder-open"></i> <span>Recursos</span></a>
        </div>
        <div class="nav-section">
          <div class="nav-section-title">Cuenta</div>
          <a href="plan.html" class="nav-item"><i class="fas fa-crown"></i> <span>Mi Plan</span></a>
          <a href="perfil.html" class="nav-item"><i class="fas fa-user-circle"></i> <span>Perfil</span></a>
          <a href="#" class="nav-item" onclick="handleLogout()"><i class="fas fa-sign-out-alt"></i> <span>Cerrar Sesión</span></a>
          <a href="configuracion.html" class="nav-item"><i class="fas fa-cog"></i> <span>Configuración</span></a>
        </div>
      </nav>
      <div class="sidebar-footer">
        <div class="user-profile">
          <div class="user-avatar" id="avatarInitials">--</div>
          <div class="user-info">
            <div class="user-name" id="sidebarUserName">Cargando...</div>
            <div class="user-email" id="sidebarUserEmail">...</div>
          </div>
        </div>
      </div>
    </aside>

    <main class="main-content">
      <div class="page-header">
        <h1>Mi Progreso</h1>
        <p class="page-subtitle">Visualiza tu evolución y celebra tus logros</p>
      </div>

      <div class="charts-grid">
        <div class="chart-card">
          <div class="chart-header">
            <div>
              <div class="chart-title">Evolución Emocional</div>
              <div class="chart-subtitle">Basado en tus tests de bienestar</div>
            </div>
          </div>
          <div class="chart-container">
            <canvas id="testsChart"></canvas>
          </div>
        </div>

        <div class="chart-card">
          <div class="chart-header">
            <div>
              <div class="chart-title">Hábitos de Escritura</div>
              <div class="chart-subtitle">Frecuencia por día de la semana</div>
            </div>
          </div>
          <div class="chart-container">
            <canvas id="diaryActivityChart"></canvas>
          </div>
        </div>
      </div>

      <div class="test-history">
        <h2 style="margin-bottom: 24px;">Historial de Evaluaciones</h2>
        </div>

      <h2 style="margin-bottom: 24px;">Patrones Identificados</h2>
      <div class="insights-grid">
        <div class="insight-card">
          <div class="insight-icon"><i class="fas fa-trophy"></i></div>
          <div class="insight-title">Constancia</div>
          <div class="insight-text" id="insightRacha">Calculando tu racha actual...</div>
        </div>
        <div class="insight-card">
          <div class="insight-icon"><i class="fas fa-chart-line"></i></div>
          <div class="insight-title">Tendencia de Ánimo</div>
          <div class="insight-text" id="insightTrend">Analizando tus últimos registros...</div>
        </div>
        <div class="insight-card">
          <div class="insight-icon"><i class="fas fa-clock"></i></div>
          <div class="insight-title">Momento de Reflexión</div>
          <div class="insight-text" id="insightReflection">Sueles escribir más en tu diario los fines de semana. ¡Es un excelente hábito!</div>
        </div>
      </div>
    </main>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="../js/supabase-config.js"></script>

  <script>
    // --- CONFIGURACIÓN DE GRÁFICOS ---
    Chart.defaults.font.family = "'DM Sans', sans-serif";
    Chart.defaults.color = '#6B7280';
    let testsChart, diaryChart;

    // --- INICIALIZACIÓN ---
    async function init() {
        const { data: { user } } = await window.supabase.auth.getUser();
        if (!user) { window.location.href = '../login.html'; return; }

        // Cargar Perfil Sidebar
        const { data: profile } = await window.supabase.from('users_profile').select('*').eq('id', user.id).single();
        if (profile) {
            document.getElementById('sidebarUserName').textContent = `${profile.nombre} ${profile.apellido}`;
            document.getElementById('sidebarUserEmail').textContent = user.email;
            document.getElementById('avatarInitials').textContent = (profile.nombre[0] + profile.apellido[0]).toUpperCase();
        }

        loadProgressData(user.id);
    }

    async function loadProgressData(userId) {
        // 1. Cargar Historial de Tests
        const { data: tests } = await window.supabase
            .from('test_results')
            .select('*')
            .eq('user_id', userId)
            .order('fecha_realizado', { ascending: false });

        if (tests) {
            renderTestHistory(tests);
            updateTestChart(tests);
            generateInsights(tests);
        }

        // 2. Cargar Actividad de Diario (Últimos 30 días)
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        
        const { data: entries } = await window.supabase
            .from('diario_emocional')
            .select('fecha')
            .eq('user_id', userId)
            .gte('fecha', thirtyDaysAgo.toISOString());

        if (entries) {
            updateDiaryChart(entries);
        }
    }

    // --- RENDERIZADO ---
    function renderTestHistory(tests) {
        const container = document.querySelector('.test-history');
        // Mantener el título H2, limpiar el resto de divs hijos
        const title = container.querySelector('h2');
        container.innerHTML = '';
        container.appendChild(title);

        if (tests.length === 0) {
            container.innerHTML += '<p style="color:var(--text-secondary); text-align:center; padding:20px;">Aún no has realizado ningún test.</p>';
            return;
        }

        tests.forEach(test => {
            const date = new Date(test.fecha_realizado);
            const day = date.getDate().toString().padStart(2, '0');
            const month = date.toLocaleString('es-ES', { month: 'short' });

            const html = `
                <div class="test-item">
                    <div class="test-date-badge">
                        <div class="test-day">${day}</div>
                        <div class="test-month">${month}</div>
                    </div>
                    <div class="test-content">
                        <div class="test-title">Evaluación de Bienestar</div>
                        <div class="test-scores">
                            <span class="score-badge ${getLevelClass(test.nivel_ansiedad)}">Ansiedad: ${test.nivel_ansiedad}/10</span>
                            <span class="score-badge ${getLevelClass(test.nivel_estres)}">Estrés: ${test.nivel_estres}/10</span>
                            <span class="score-badge ${test.nivel_animo >= 7 ? 'low' : (test.nivel_animo >= 4 ? 'medium' : 'high')}">Ánimo: ${test.nivel_animo}/10</span>
                        </div>
                    </div>
                </div>`;
            container.insertAdjacentHTML('beforeend', html);
        });
    }

    function getLevelClass(val) {
        return val <= 3 ? 'low' : (val <= 6 ? 'medium' : 'high');
    }

    // --- GRÁFICOS ---
    function updateTestChart(tests) {
        const ctx = document.getElementById('testsChart').getContext('2d');
        // Invertir para mostrar cronológico en gráfico (antiguo -> nuevo)
        const cronoTests = [...tests].reverse();
        
        testsChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: cronoTests.map(t => new Date(t.fecha_realizado).toLocaleDateString('es-ES', {day: '2-digit', month: 'short'})),
                datasets: [
                    { label: 'Ansiedad', data: cronoTests.map(t => t.nivel_ansiedad), borderColor: '#EF4444', tension: 0.3 },
                    { label: 'Estrés', data: cronoTests.map(t => t.nivel_estres), borderColor: '#F59E0B', tension: 0.3 },
                    { label: 'Ánimo', data: cronoTests.map(t => t.nivel_animo), borderColor: '#10B981', tension: 0.3 }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { min: 0, max: 10 } } }
        });
    }

    function updateDiaryChart(entries) {
        const ctx = document.getElementById('diaryActivityChart').getContext('2d');
        const dayCounts = [0, 0, 0, 0, 0, 0, 0]; // Dom-Sáb
        
        entries.forEach(e => {
            const dayIndex = new Date(e.fecha).getDay(); // 0 = Domingo
            dayCounts[dayIndex]++;
        });

        // Reordenar para empezar Lunes (1) hasta Domingo (0)
        const orderedCounts = [...dayCounts.slice(1), dayCounts[0]];

        diaryChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom'],
                datasets: [{
                    label: 'Entradas',
                    data: orderedCounts,
                    backgroundColor: '#4F6F52',
                    borderRadius: 4
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
        });
    }

    // --- INSIGHTS ---
    function generateInsights(tests) {
        // Racha (placeholder, idealmente calculado con diario)
        document.getElementById('insightRacha').textContent = "Mantener la constancia es clave. ¡Sigue así!";

        // Tendencia Ánimo
        if (tests.length >= 2) {
            const current = tests[0].nivel_animo;
            const previous = tests[1].nivel_animo;
            const diff = current - previous;
            
            let msg = "";
            if (diff > 0) msg = "Tu estado de ánimo ha mejorado respecto a tu última evaluación.";
            else if (diff < 0) msg = "Tu ánimo ha bajado un poco. Es normal tener altibajos, sé amable contigo.";
            else msg = "Tu estado de ánimo se mantiene estable.";
            
            document.getElementById('insightTrend').textContent = msg;
        } else {
            document.getElementById('insightTrend').textContent = "Realiza más evaluaciones para detectar tendencias.";
        }
    }

    async function handleLogout() {
        await window.supabase.auth.signOut();
        window.location.href = '../login.html';
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
