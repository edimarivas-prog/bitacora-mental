<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mi Progreso - Bitácora Mental</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700&family=DM+Sans:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* Estilos Base (Iguales) */
    :root { --primary: #4F6F52; --bg: #F3F6F4; --white: #fff; --text: #1F2933; --border: #E6EFE8; --radius: 20px; }
    body { font-family: 'DM Sans', sans-serif; background: var(--bg); margin: 0; display: flex; }
    .sidebar { width: 260px; background: white; padding: 24px; border-right: 1px solid var(--border); position: fixed; height: 100%; top: 0; display: flex; flex-direction: column; z-index: 100; }
    .main { flex: 1; padding: 30px; margin-left: 260px; }
    
    .grid-charts { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .chart-card { background: white; padding: 25px; border-radius: var(--radius); box-shadow: 0 4px 20px rgba(0,0,0,0.04); height: 350px; }
    .insight-card { background: linear-gradient(135deg, var(--primary), #3E5A41); color: white; padding: 25px; border-radius: var(--radius); margin-bottom: 20px; display: flex; align-items: center; gap: 20px; }
    
    @media (max-width: 900px) { .sidebar { display: none; } .main { margin-left: 0; padding: 20px; } }
  </style>
</head>
<body>
  <aside class="sidebar">
    <a href="dashboard.html" style="font-family:'Outfit'; font-weight:700; color:var(--primary); font-size:1.3rem; margin-bottom:30px; text-decoration:none;"><i class="fas fa-brain"></i> Bitácora</a>
    <nav style="display:flex; flex-direction:column; gap:5px;">
        <a href="dashboard.html" style="padding:12px; color:#64748B; text-decoration:none;"><i class="fas fa-home"></i> Inicio</a>
        <a href="diario.html" style="padding:12px; color:#64748B; text-decoration:none;"><i class="fas fa-book"></i> Diario</a>
        <a href="progreso.html" style="padding:12px; background:#E8F5E9; color:var(--primary); font-weight:600; text-decoration:none; border-radius:12px;"><i class="fas fa-chart-line"></i> Progreso</a>
        <a href="citas.html" style="padding:12px; color:#64748B; text-decoration:none;"><i class="fas fa-calendar-alt"></i> Citas</a>
        <a href="recursos.html" style="padding:12px; color:#64748B; text-decoration:none;"><i class="fas fa-box-open"></i> Recursos</a>
    </nav>
  </aside>

  <main class="main">
    <h1 style="font-family:'Outfit'; margin-bottom:20px;">Tu Evolución</h1>

    <div class="insight-card">
      <i class="fas fa-trophy" style="font-size:2.5rem; opacity:0.8;"></i>
      <div>
        <h3 style="margin:0 0 5px 0;">¡Vas por buen camino!</h3>
        <p style="margin:0; opacity:0.9;" id="insightText">Analizando tus datos...</p>
      </div>
    </div>

    <div class="grid-charts">
      <div class="chart-card">
        <h4 style="margin:0 0 15px 0; color:var(--primary);">Estado de Ánimo (Últimos 30 días)</h4>
        <canvas id="moodChart"></canvas>
      </div>
      <div class="chart-card">
        <h4 style="margin:0 0 15px 0; color:var(--primary);">Frecuencia de Diario</h4>
        <canvas id="journalChart"></canvas>
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="../js/supabase-config.js"></script>
  <script>
    async function checkAuth() {
        if (!window.sb) { setTimeout(checkAuth, 100); return; }
        const { data: { session } } = await window.sb.auth.getSession();
        if (!session) window.location.replace('../login.html');
        else loadData(session.user);
    }
    checkAuth();

    async function loadData(user) {
        // 1. Datos de Pulso (Ánimo)
        const { data: pulses } = await window.sb.from('monitoreo_sintomas')
            .select('fecha_realizado, nivel_animo')
            .eq('user_id', user.id)
            .order('fecha_realizado', { ascending: true });

        const moodCtx = document.getElementById('moodChart').getContext('2d');
        new Chart(moodCtx, {
            type: 'line',
            data: {
                labels: pulses?.map(p => new Date(p.fecha_realizado).toLocaleDateString('es-PE', {day:'2-digit', month:'short'})) || [],
                datasets: [{
                    label: 'Ánimo (0-10)',
                    data: pulses?.map(p => p.nivel_animo) || [],
                    borderColor: '#4F6F52',
                    backgroundColor: 'rgba(79, 111, 82, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { min: 0, max: 10 } } }
        });

        // 2. Datos de Diario (Consistencia)
        const { data: entries } = await window.sb.from('diario_emocional').select('fecha').eq('user_id', user.id);
        const count = entries?.length || 0;
        document.getElementById('insightText').textContent = count > 0 
            ? `Has escrito ${count} veces en tu diario. La constancia es clave.` 
            : "Empieza a escribir en tu diario para ver tus estadísticas aquí.";

        // Gráfico de barras simple (Días de la semana)
        const journalCtx = document.getElementById('journalChart').getContext('2d');
        new Chart(journalCtx, {
            type: 'bar',
            data: {
                labels: ['Total Entradas'],
                datasets: [{
                    label: 'Entradas',
                    data: [count],
                    backgroundColor: '#F59E0B',
                    borderRadius: 10
                }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }
  </script>
</body>
</html>
