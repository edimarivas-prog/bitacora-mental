<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mi Progreso - Bitácora Mental</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  
  <style>
    /* Estilos Base */
    :root {
      --primary: #4F6F52;
      --primary-light: #6B8A6E;
      --secondary: #A7C4B5;
      --background: #F9FBFA;
      --card-bg: #FFFFFF;
      --dark: #1F2933;
      --text-secondary: #6B7280;
      --border: #E6EFE8;
      --success: #10B981;
      --warning: #F59E0B;
      --danger: #EF4444;
      --radius: 16px;
      --shadow: 0 4px 20px rgba(0,0,0,0.06);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'DM Sans', sans-serif; background: var(--background); color: var(--dark); line-height: 1.6; }
    h1, h2, h3, h4 { font-family: 'Outfit', sans-serif; font-weight: 600; }

    .dashboard-container { display: grid; grid-template-columns: 260px 1fr; min-height: 100vh; }

    /* Sidebar */
    .sidebar { background: white; border-right: 1px solid var(--border); padding: 24px 0; position: sticky; top: 0; height: 100vh; display: flex; flex-direction: column; }
    .sidebar-header { padding: 0 24px 24px; border-bottom: 1px solid var(--border); }
    .logo { display: flex; align-items: center; gap: 12px; font-family: 'Outfit', sans-serif; font-weight: 700; font-size: 1.3rem; color: var(--primary); text-decoration: none; }
    .sidebar-nav { flex: 1; padding: 24px 0; overflow-y: auto; }
    .nav-section { margin-bottom: 24px; }
    .nav-section-title { font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-secondary); padding: 0 24px 8px; }
    .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 24px; color: var(--dark); text-decoration: none; transition: all 0.2s; border-left: 3px solid transparent; }
    .nav-item:hover { background: var(--background); color: var(--primary); }
    .nav-item.active { background: rgba(79, 111, 82, 0.08); color: var(--primary); border-left-color: var(--primary); font-weight: 600; }
    
    .sidebar-footer { padding: 0 24px; border-top: 1px solid var(--border); padding-top: 20px; margin-top: auto; }
    .user-profile { display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--background); border-radius: 12px; cursor: pointer; transition: all 0.2s; }
    .user-profile:hover { background: var(--border); }
    .user-avatar { width: 40px; height: 40px; background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 1rem; }
    .user-info { flex: 1; min-width: 0; }
    .user-name { font-weight: 600; font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .user-email { font-size: 0.75rem; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    /* Main Content */
    .main-content { padding: 32px 40px; max-width: 1400px; }
    .page-header { margin-bottom: 32px; }
    .page-header h1 { font-size: 2rem; margin-bottom: 8px; color: var(--dark); }
    .page-subtitle { color: var(--text-secondary); font-size: 1rem; }

    /* Charts Grid */
    .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 24px; margin-bottom: 32px; }
    .chart-card { background: white; border-radius: 16px; padding: 28px; box-shadow: 0 4px 20px rgba(0,0,0,0.06); }
    .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
    .chart-title { font-size: 1.2rem; font-weight: 600; }
    .chart-subtitle { color: var(--text-secondary); font-size: 0.9rem; margin-top: 4px; }
    .chart-container { position: relative; height: 300px; }

    /* Insights Grid */
    .insights-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 32px; }
    .insight-card { background: white; border-radius: 16px; padding: 24px; box-shadow: 0 4px 20px rgba(0,0,0,0.06); border-left: 4px solid var(--primary); }
    .insight-icon { width: 40px; height: 40px; border-radius: 10px; background: rgba(79, 111, 82, 0.1); color: var(--primary); display: flex; align-items: center; justify-content: center; margin-bottom: 16px; font-size: 1.3rem; }
    .insight-title { font-size: 1rem; font-weight: 600; margin-bottom: 8px; }
    .insight-text { color: var(--text-secondary); font-size: 0.9rem; line-height: 1.6; }

    @media (max-width: 968px) {
      .dashboard-container { grid-template-columns: 1fr; }
      .sidebar { display: none; }
      .main-content { padding: 20px; }
      .charts-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="dashboard-container">
    <aside class="sidebar">
      <div class="sidebar-header">
        <a href="dashboard.html" class="logo"><i class="fas fa-brain"></i> Bitácora Mental</a>
      </div>
      <nav class="sidebar-nav">
        <div class="nav-section">
          <div class="nav-section-title">Principal</div>
          <a href="dashboard.html" class="nav-item"><i class="fas fa-home"></i> <span>Dashboard</span></a>
          <a href="citas.html" class="nav-item"><i class="fas fa-calendar-alt"></i> <span>Mis Citas</span></a>
          <a href="especialistas.html" class="nav-item"><i class="fas fa-user-md"></i> <span>Especialistas</span></a>
        </div>
        <div class="nav-section">
          <div class="nav-section-title">Mi Espacio</div>
          <a href="diario.html" class="nav-item"><i class="fas fa-book"></i> <span>Mi Diario</span></a>
          <a href="progreso.html" class="nav-item active"><i class="fas fa-chart-line"></i> <span>Mi Progreso</span></a>
          <a href="recursos.html" class="nav-item"><i class="fas fa-folder-open"></i> <span>Recursos</span></a>
        </div>
        <div class="nav-section">
          <div class="nav-section-title">Cuenta</div>
          <a href="plan.html" class="nav-item"><i class="fas fa-crown"></i> <span>Mi Plan</span></a>
          <a href="perfil.html" class="nav-item"><i class="fas fa-user-circle"></i> <span>Perfil</span></a>
          <a href="#" class="nav-item" onclick="handleLogout()"><i class="fas fa-sign-out-alt"></i> <span>Cerrar Sesión</span></a>
          <a href="configuracion.html" class="nav-item"><i class="fas fa-cog"></i> <span>Configuración</span></a>
        </div>
      </nav>
      <div class="sidebar-footer">
        <div class="user-profile">
          <div class="user-avatar" id="avatarInitials">--</div>
          <div class="user-info">
            <div class="user-name" id="sidebarUserName">Cargando...</div>
            <div class="user-email" id="sidebarUserEmail">...</div>
          </div>
        </div>
      </div>
    </aside>

    <main class="main-content">
      <div class="page-header">
        <h1>Mi Progreso</h1>
        <p class="page-subtitle">Visualiza tu evolución y celebra tus logros</p>
      </div>

      <div class="insights-grid">
        <div class="insight-card">
          <div class="insight-icon"><i class="fas fa-trophy"></i></div>
          <div class="insight-title">Tu Constancia</div>
          <div class="insight-text" id="insightRacha">Calculando...</div>
        </div>
        <div class="insight-card">
          <div class="insight-icon"><i class="fas fa-lightbulb"></i></div>
          <div class="insight-title">Tu Ritmo</div>
          <div class="insight-text" id="insightPattern">Analizando cuándo escribes...</div>
        </div>
        <div class="insight-card">
          <div class="insight-icon"><i class="fas fa-heart"></i></div>
          <div class="insight-title">Estado Emocional</div>
          <div class="insight-text" id="insightTrend">Revisando tus últimos tests...</div>
        </div>
      </div>

      <div class="charts-grid">
        <div class="chart-card">
          <div class="chart-header">
            <div>
              <div class="chart-title">Evolución Emocional</div>
              <div class="chart-subtitle">Cómo te has sentido en tus evaluaciones</div>
            </div>
          </div>
          <div class="chart-container">
            <canvas id="testsChart"></canvas>
          </div>
        </div>

        <div class="chart-card">
          <div class="chart-header">
            <div>
              <div class="chart-title">Momentos de Escritura</div>
              <div class="chart-subtitle">Tus días preferidos para expresarte</div>
            </div>
          </div>
          <div class="chart-container">
            <canvas id="diaryActivityChart"></canvas>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="../js/supabase-config.js"></script>

  <script>
    Chart.defaults.font.family = "'DM Sans', sans-serif";
    Chart.defaults.color = '#6B7280';
    let testsChart, diaryChart;

    async function init() {
        const { data: { user } } = await window.supabase.auth.getUser();
        if (!user) { window.location.href = '../login.html'; return; }

        const { data: profile } = await window.supabase.from('users_profile').select('*').eq('id', user.id).single();
        if (profile) {
            document.getElementById('sidebarUserName').textContent = `${profile.nombre} ${profile.apellido}`;
            document.getElementById('sidebarUserEmail').textContent = user.email;
            document.getElementById('avatarInitials').textContent = (profile.nombre[0] + profile.apellido[0]).toUpperCase();
        }

        loadProgressData(user.id);
    }

    async function loadProgressData(userId) {
        // 1. Cargar Tests
        const { data: tests } = await window.supabase
            .from('test_results')
            .select('*')
            .eq('user_id', userId)
            .order('fecha_realizado', { ascending: true }); // Orden cronológico para gráfico

        if (tests && tests.length > 0) {
            updateTestChart(tests);
            analyzeTrend(tests);
        } else {
            document.getElementById('insightTrend').textContent = "Realiza tu primer test para ver tu evolución emocional aquí.";
        }

        // 2. Cargar Diario (Para Racha y Patrones)
        const { data: entries } = await window.supabase
            .from('diario_emocional')
            .select('fecha')
            .eq('user_id', userId);

        if (entries && entries.length > 0) {
            // Filtrar fechas futuras (Protección de datos)
            const today = new Date();
            today.setHours(23, 59, 59, 999);
            const validEntries = entries.filter(e => new Date(e.fecha) <= today);

            updateDiaryChart(validEntries);
            calculateInsights(validEntries);
        } else {
            document.getElementById('insightRacha').textContent = "Empieza a escribir en tu diario para generar tu racha.";
            document.getElementById('insightPattern').textContent = "Pronto descubrirás qué días sueles escribir más.";
        }
    }

    // --- GRÁFICOS ---

    function updateTestChart(tests) {
        const ctx = document.getElementById('testsChart').getContext('2d');
        
        // Configuración "Humana" del eje Y
        const yLabels = { 0: '', 2: 'Crítico', 4: 'Bajo', 6: 'Moderado', 8: 'Bueno', 10: 'Excelente' };

        testsChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: tests.map(t => new Date(t.fecha_realizado).toLocaleDateString('es-ES', {day: '2-digit', month: 'short'})),
                datasets: [
                    { label: 'Ánimo', data: tests.map(t => t.nivel_animo), borderColor: '#10B981', backgroundColor: '#10B981', tension: 0.4, pointRadius: 4 },
                    { label: 'Ansiedad', data: tests.map(t => t.nivel_ansiedad), borderColor: '#EF4444', backgroundColor: '#EF4444', tension: 0.4, pointRadius: 4 }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        min: 0, max: 10,
                        ticks: {
                            callback: function(value) { return yLabels[value] || ''; },
                            stepSize: 2
                        },
                        grid: { color: '#F3F4F6' }
                    },
                    x: { grid: { display: false } }
                },
                plugins: { legend: { position: 'bottom' } }
            }
        });
    }

    function updateDiaryChart(entries) {
        const ctx = document.getElementById('diaryActivityChart').getContext('2d');
        const dayCounts = [0, 0, 0, 0, 0, 0, 0]; // Dom-Sáb
        
        // Agrupar por día de la semana
        entries.forEach(e => {
            // Usamos UTC o local pero consistente
            const date = new Date(e.fecha); 
            const dayIndex = date.getDay(); 
            dayCounts[dayIndex]++;
        });

        // Mover Domingo al final (Lunes=0 ... Domingo=6 visualmente)
        const labels = ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom'];
        const data = [...dayCounts.slice(1), dayCounts[0]];

        diaryChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Momentos de escritura',
                    data: data,
                    backgroundColor: '#4F6F52',
                    borderRadius: 6,
                    barThickness: 20
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, ticks: { stepSize: 1 }, grid: { display: false } },
                    x: { grid: { display: false } }
                },
                plugins: { legend: { display: false } }
            }
        });
    }

    // --- INSIGHTS INTELIGENTES ---

    function calculateInsights(entries) {
        // 1. Racha Real (Días consecutivos únicos)
        // Convertimos a Set de fechas string YYYY-MM-DD para eliminar duplicados del mismo día
        const uniqueDates = new Set(entries.map(e => e.fecha.split('T')[0]));
        const sortedDates = Array.from(uniqueDates).sort().reverse(); // Hoy hacia atrás

        let streak = 0;
        if (sortedDates.length > 0) {
            const today = new Date().toISOString().split('T')[0];
            const yesterdayDate = new Date(); yesterdayDate.setDate(yesterdayDate.getDate() - 1);
            const yesterday = yesterdayDate.toISOString().split('T')[0];

            // Si escribió hoy o ayer, la racha está viva
            if (sortedDates[0] === today || sortedDates[0] === yesterday) {
                streak = 1;
                let checkDate = new Date(sortedDates[0]);
                
                for (let i = 1; i < sortedDates.length; i++) {
                    checkDate.setDate(checkDate.getDate() - 1);
                    if (sortedDates[i] === checkDate.toISOString().split('T')[0]) {
                        streak++;
                    } else {
                        break;
                    }
                }
            }
        }
        
        const streakMsg = streak > 1 
            ? `¡Llevas ${streak} días seguidos escribiendo! Esa constancia es clave.` 
            : (streak === 1 ? "Has empezado una racha hoy. ¡Vuelve mañana para mantenerla!" : "Hace días que no escribes. Hoy es un buen día para retomar.");
        
        document.getElementById('insightRacha').textContent = streakMsg;

        // 2. Patrón de Día Preferido
        const dayCounts = [0, 0, 0, 0, 0, 0, 0];
        entries.forEach(e => dayCounts[new Date(e.fecha).getDay()]++);
        
        const maxVal = Math.max(...dayCounts);
        const maxDayIndex = dayCounts.indexOf(maxVal);
        const dayNames = ["Domingos", "Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábados"];
        
        if (entries.length < 3) {
            document.getElementById('insightPattern').textContent = "Aún estamos aprendiendo tus hábitos. Escribe un poco más para ver patrones.";
        } else {
            document.getElementById('insightPattern').textContent = `Parece que los ${dayNames[maxDayIndex]} son tu momento de mayor reflexión.`;
        }
    }

    function analyzeTrend(tests) {
        if (tests.length < 2) {
            document.getElementById('insightTrend').textContent = "Necesitamos al menos dos evaluaciones para decirte cómo has avanzado.";
            return;
        }

        // Comparar último vs penúltimo
        const last = tests[tests.length - 1];
        const prev = tests[tests.length - 2];

        let msg = "";
        if (last.nivel_animo > prev.nivel_animo) {
            msg = "¡Tu ánimo ha mejorado desde la última vez! Sigue cuidando de ti.";
        } else if (last.nivel_ansiedad < prev.nivel_ansiedad) {
            msg = "Has logrado reducir tu ansiedad comparado con el test anterior. ¡Gran trabajo!";
        } else if (Math.abs(last.nivel_animo - prev.nivel_animo) <= 1) {
            msg = "Tu bienestar se mantiene estable. La estabilidad también es un logro.";
        } else {
            msg = "Parece que ha sido una semana difícil. Recuerda ser amable contigo mismo.";
        }
        document.getElementById('insightTrend').textContent = msg;
    }

    async function handleLogout() {
        await window.supabase.auth.signOut();
        window.location.href = '../login.html';
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
