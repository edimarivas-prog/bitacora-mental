<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test de Bienestar - Bit√°cora Mental</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    :root {
      --primary: #4F6F52;
      --primary-light: #6B8A6E;
      --secondary: #A7C4B5;
      --background: #F9FBFA;
      --dark: #1F2933;
      --text-secondary: #6B7280;
      --border: #E6EFE8;
      --danger: #EF4444;
      --warning: #F59E0B;
      --success: #10B981;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'DM Sans', sans-serif; background: var(--background); color: var(--dark); line-height: 1.6; }
    h1, h2, h3 { font-family: 'Outfit', sans-serif; }

    .test-container { max-width: 850px; margin: 0 auto; padding: 40px 20px; min-height: 100vh; }
    
    /* Elements */
    .card { background: white; border-radius: 24px; padding: 40px; box-shadow: 0 10px 40px rgba(0,0,0,0.08); margin-bottom: 30px; border: 1px solid var(--border); }
    .welcome-screen { text-align: center; }
    
    /* Progress */
    .progress-container { margin-bottom: 32px; background: white; padding: 20px; border-radius: 16px; border: 1px solid var(--border); }
    .progress-bar { width: 100%; height: 8px; background: var(--border); border-radius: 10px; overflow: hidden; }
    .progress-fill { height: 100%; background: var(--primary); transition: width 0.4s ease; width: 0%; }

    /* Messages & Validation */
    .validation-msg { background: #E8F3EC; color: var(--primary); padding: 15px; border-radius: 12px; margin-bottom: 20px; font-weight: 600; font-size: 0.9rem; animation: fadeIn 0.5s ease; display: none; }
    
    /* Options */
    .scale-options { display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; margin: 30px 0; }
    .scale-option { aspect-ratio: 1; border: 2px solid var(--border); border-radius: 15px; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: 0.3s; }
    .scale-option.selected { background: var(--primary); border-color: var(--primary); color: white; transform: scale(1.05); }

    /* Results Screen */
    .results-screen { display: none; }
    .results-screen.active { display: block; }
    .casuistica-box { background: #f0f4f1; padding: 25px; border-radius: 18px; margin: 20px 0; border-left: 5px solid var(--primary); text-align: left; }
    .tip-box { background: #FFF9E6; padding: 20px; border-radius: 15px; margin: 20px 0; border: 1px solid #FFE082; }
    
    .btn { width: 100%; padding: 16px; border-radius: 12px; font-weight: 700; cursor: pointer; border: none; transition: 0.3s; font-size: 1rem; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-plan { background: linear-gradient(135deg, var(--primary), var(--primary-light)); color: white; margin-top: 15px; }

    /* Countdown & Urgency */
    .countdown-timer { background: #FFF4F4; color: #D32F2F; padding: 8px 15px; border-radius: 50px; font-weight: 700; font-size: 0.85rem; margin-bottom: 20px; display: inline-block; border: 1px solid #FFCDD2; }

    @media (max-width: 768px) { .scale-options { gap: 8px; } .scale-option { border-radius: 10px; } }
  </style>
</head>
<body>
  <div class="test-container">
    <div class="test-header" style="text-align: center; margin-bottom: 30px;">
      <a href="index.html" style="text-decoration: none; color: var(--primary); font-weight: 700; font-size: 1.5rem;"><i class="fas fa-brain"></i> Bit√°cora Mental</a>
    </div>

    <div class="progress-container" id="progressContainer" style="display: none;">
      <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
      <p style="text-align: center; margin-top: 10px; font-size: 0.85rem; color: var(--text-secondary);">Pregunta <span id="currentQNum">1</span> de 10</p>
    </div>

    <div id="validationMsg" class="validation-msg"></div>

    <div class="card welcome-screen" id="welcomeScreen">
      <div style="font-size: 4rem; color: var(--primary); margin-bottom: 20px;"><i class="fas fa-heartbeat"></i></div>
      <h1>Test de Bienestar Emocional</h1>
      <p>Este es un espacio seguro. Responde con honestidad para que podamos entender tu momento actual y ofrecerte el apoyo que realmente necesitas.</p>
      <div style="background: var(--background); padding: 20px; border-radius: 15px; margin: 25px 0; text-align: left;">
        <div style="margin-bottom: 10px;"><i class="fas fa-clock" style="color: var(--primary)"></i> 5 minutos de introspecci√≥n</div>
        <div style="margin-bottom: 10px;"><i class="fas fa-lock" style="color: var(--primary)"></i> 100% privado y confidencial</div>
        <div><i class="fas fa-gift" style="color: var(--primary)"></i> Recursos gratuitos al finalizar</div>
      </div>
      <button class="btn btn-primary" onclick="startTest()">Comenzar con calma</button>
    </div>

    <div id="questionsContainer"></div>

    <div class="results-screen" id="resultsScreen">
      <div class="card" style="text-align: center;">
        <div class="countdown-timer" id="countdownBanner"><i class="fas fa-clock"></i> Tu reporte y recursos expiran en: <span id="timer">15:00</span></div>
        <h2 id="resultTitle">Analizando tus respuestas...</h2>
        
        <div id="humanSummary" class="casuistica-box"></div>
        
        <div id="quickWin" class="tip-box"></div>

        <div style="background: #E8F3EC; padding: 20px; border-radius: 15px; margin-top: 25px;">
          <h4 style="color: var(--primary); margin-bottom: 10px;"><i class="fas fa-user-md"></i> Orientaci√≥n Cl√≠nica Sugerida</h4>
          <p id="clinicalMatch" style="font-size: 0.95rem;"></p>
        </div>
      </div>

      <div class="card" style="background: var(--primary); color: white; text-align: center;">
        <h3>üéÅ ¬°Tu Regalo de Bienvenida est√° listo!</h3>
        <p style="margin: 15px 0; opacity: 0.9;">Hemos desbloqueado recursos gratuitos para tu perfil en tu cuenta nueva:</p>
        <ul style="text-align: left; margin: 0 auto 25px; max-width: 400px; font-size: 0.9rem;">
          <li><i class="fas fa-check"></i> Gu√≠a: "Pasos para tu primera sesi√≥n"</li>
          <li><i class="fas fa-check"></i> Audio de respiraci√≥n para tu perfil</li>
          <li><i class="fas fa-check"></i> Tu reporte detallado en PDF</li>
        </ul>
        <button class="btn" style="background: white; color: var(--primary);" onclick="window.location.href='registro.html'">Guardar mis resultados y recursos gratis</button>
      </div>

      <h3 style="text-align: center; margin: 40px 0 20px;">Planes de apoyo profesional personalizados</h3>
      <div id="plansGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;"></div>
    </div>
  </div>

  <script>
    const questions = [
      { id: 1, cat: 'ansiedad', text: '¬øCon qu√© frecuencia te sientes nervioso/a o con inquietud?', labels: ['Nunca', 'Rara vez', 'A veces', 'Frecuente', 'Siempre'] },
      { id: 2, cat: 'ansiedad', text: '¬øSientes que tus pensamientos van m√°s r√°pido de lo que puedes manejar?', labels: ['Nunca', 'Rara vez', 'A veces', 'Frecuente', 'Siempre'] },
      { id: 3, cat: 'estres', text: '¬øSientes que las responsabilidades diarias te abruman f√≠sicamente?', labels: ['Nunca', 'Rara vez', 'A veces', 'Frecuente', 'Siempre'] },
      { id: 4, cat: 'sueno', text: '¬øTe cuesta conciliar el sue√±o porque no puedes dejar de pensar?', labels: ['Nunca', 'Rara vez', 'A veces', 'Frecuente', 'Siempre'] },
      { id: 5, cat: 'animo', text: '¬øC√≥mo describir√≠as tu nivel de energ√≠a emocional hoy?', labels: ['Muy bajo', 'Bajo', 'Neutro', 'Bueno', 'Excelente'] },
      { id: 6, cat: 'animo', text: '¬øHas perdido el inter√©s por cosas que antes disfrutabas?', labels: ['Nunca', 'Rara vez', 'A veces', 'Frecuente', 'Siempre'] },
      { id: 7, cat: 'social', text: '¬øSientes que tienes a alguien en quien confiar plenamente?', labels: ['Nunca', 'Rara vez', 'A veces', 'Frecuente', 'Siempre'] },
      { id: 8, cat: 'motivacion', text: '¬øSientes esperanza respecto a tus proyectos futuros?', labels: ['Nunca', 'Rara vez', 'A veces', 'Frecuente', 'Siempre'] },
      { id: 9, cat: 'estres', text: '¬øSientes tensi√≥n en tu cuerpo (hombros, mand√≠bula) seguido?', labels: ['Nunca', 'Rara vez', 'A veces', 'Frecuente', 'Siempre'] },
      { id: 10, cat: 'general', text: '¬øQu√© tanta prioridad le has dado a tu salud mental este mes?', labels: ['Ninguna', 'Poca', 'Regular', 'Mucha', 'Total'] }
    ];

    let currentIdx = 0;
    let answers = {};

    function startTest() {
      document.getElementById('welcomeScreen').style.display = 'none';
      document.getElementById('progressContainer').style.display = 'block';
      renderQ(0);
    }

    function renderQ(idx) {
      const q = questions[idx];
      const container = document.getElementById('questionsContainer');
      
      // Validaci√≥n intermedia
      const vMsg = document.getElementById('validationMsg');
      if(idx === 5) {
        vMsg.innerText = "Est√°s haciendo un gran trabajo al tomarte este tiempo para ti. Ya estamos a mitad de camino.";
        vMsg.style.display = 'block';
      } else { vMsg.style.display = 'none'; }

      container.innerHTML = `
        <div class="card active" style="animation: fadeInUp 0.4s ease;">
          <h2 style="margin-bottom: 25px; font-size: 1.4rem;">${q.text}</h2>
          <div class="scale-options">
            ${[1,2,3,4,5].map(v => `
              <div class="scale-option ${answers[q.id] == v ? 'selected' : ''}" onclick="select(${q.id}, ${v})">
                <span style="font-size: 1.5rem; font-weight: 700;">${v}</span>
                <span style="font-size: 0.7rem; text-align: center;">${q.labels[v-1]}</span>
              </div>`).join('')}
          </div>
          <div style="display: flex; gap: 15px;">
            ${idx > 0 ? `<button class="btn btn-secondary" onclick="renderQ(${idx-1})">Anterior</button>` : ''}
            <button class="btn btn-primary" onclick="next(${idx})" ${answers[q.id] ? '' : 'disabled'}>${idx === 9 ? 'Ver mi an√°lisis personal' : 'Siguiente'}</button>
          </div>
        </div>`;
      document.getElementById('currentQNum').innerText = idx + 1;
      document.getElementById('progressFill').style.width = ((idx + 1) / 10) * 100 + '%';
    }

    function select(id, v) { answers[id] = v; renderQ(questions.findIndex(q => q.id === id)); }
    
    function next(idx) { 
      if(idx < 9) { currentIdx = idx + 1; renderQ(currentIdx); } 
      else showResults();
    }

    function showResults() {
      // 1. CORRECCI√ìN DE NOMBRES (Para que coincidan con Supabase)
      const scores = {
        ansiedad: Math.round(((answers[1] + answers[2]) / 10) * 10),
        estres: Math.round(((answers[3] + answers[9]) / 10) * 10), // Nota: Us√© preg 3 y 9 para estr√©s seg√∫n tu l√≥gica anterior
        animo: Math.round(((12 - (answers[5] + answers[6])) / 10) * 10),
        social: answers[7],
        sueno: answers[4]
      };

      // 2. EL PUENTE DE DATOS (¬°Muy importante!)
      // Guardamos esto para que el Dashboard lo lea despu√©s del registro
      localStorage.setItem('tempTestResults', JSON.stringify(scores));

      // 3. Renderizado de la pantalla (Igual que antes)
      document.getElementById('questionsContainer').style.display = 'none';
      document.getElementById('progressContainer').style.display = 'none';
      document.getElementById('resultsScreen').classList.add('active');

      // L√≥gica de Casu√≠sticas
      let casuistica = "";
      let tip = "";
      let clinical = "";
      let recommendedPlanId = "acom"; // Default

      // Usamos las variables con nombre completo ahora: scores.ansiedad, etc.
      if(scores.ansiedad >= 7 && scores.sueno <= 2) {
        casuistica = "<strong>Perfil: Rumiaci√≥n.</strong> Parece que al llegar la noche, tu mente se convierte en un lugar ruidoso. Analizar cada detalle del pasado o preocuparte por el futuro te est√° robando el descanso.";
        tip = "<strong>Tip de hoy:</strong> Prueba el 'vaciado mental' 30 minutos antes de dormir escribiendo tus pendientes en un papel.";
        clinical = "Te beneficiar√≠as de un especialista con enfoque en <strong>Terapia Cognitivo-Conductual (TCC)</strong>.";
      } else if(scores.estres >= 7) {
        casuistica = "<strong>Perfil: Burnout.</strong> Tu bater√≠a interna est√° en rojo. Sentimos que has estado priorizando las necesidades de todos por encima de las tuyas y tu cuerpo env√≠a se√±ales de agotamiento.";
        tip = "<strong>Tip de hoy:</strong> Elige 10 minutos hoy para no hacer nada 'productivo'. Solo respira.";
        clinical = "Recomendamos un enfoque en <strong>Mindfulness y Regulaci√≥n del Sistema Nervioso</strong>.";
      } else if(scores.animo <= 4) { // Ojo: √Ånimo bajo es preocupaci√≥n
        casuistica = "<strong>Perfil: Desconexi√≥n.</strong> √öltimamente el mundo se siente un poco m√°s gris. Es v√°lido no estar bien todo el tiempo.";
        tip = "<strong>Tip de hoy:</strong> Env√≠a un mensaje corto de 'Hola' a alguien en quien conf√≠es plenamente.";
        clinical = "Tu perfil sugiere acompa√±amiento de un <strong>Psic√≥logo Cl√≠nico especializado en regulaci√≥n emocional</strong>.";
        recommendedPlanId = "prem";
      } else {
        casuistica = "<strong>Perfil: B√∫squeda de Crecimiento.</strong> Tienes bases s√≥lidas. Est√°s aqu√≠ para adquirir herramientas que protejan tu paz a largo plazo.";
        tip = "<strong>Tip de hoy:</strong> Escribe una cosa por la que est√©s agradecido hoy para fortalecer tu bienestar.";
        clinical = "Un enfoque de <strong>Psicolog√≠a Positiva o Coaching emocional</strong> ser√≠a ideal para ti.";
      }

      document.getElementById('humanSummary').innerHTML = casuistica;
      document.getElementById('quickWin').innerHTML = tip;
      document.getElementById('clinicalMatch').innerHTML = clinical;

      renderPlans(scores, recommendedPlanId);
      startTimer();
    }

    function renderPlans(scores, recommendedId) {
      const plans = [
        { id: 'kit', name: 'Kit Emocional', price: 'S/ 19', feat: ['Audios relajaci√≥n', '5 Workbooks'], show: true },
        { id: 'acom', name: 'Acompa√±amiento', price: 'S/ 165', feat: ['2 sesiones/mes', 'Soporte WhatsApp'], show: true },
        { id: 'prem', name: 'Premium', price: 'S/ 300', feat: ['4 sesiones/mes', 'Psic√≥logos senior'], show: true }
      ];

      document.getElementById('plansGrid').innerHTML = plans.map(p => `
        <div class="card" style="padding: 30px; border: 2px solid ${p.id === recommendedId ? 'var(--primary)' : 'var(--border)'}; position: relative;">
          ${p.id === recommendedId ? '<div style="position: absolute; top: -12px; right: 20px; background: var(--primary); color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.7rem; font-weight: 700;">RECOMENDADO</div>' : ''}
          <h3 style="margin-bottom: 10px;">${p.name}</h3>
          <div style="font-size: 2rem; font-weight: 700; color: var(--primary);">${p.price}</div>
          <ul style="list-style: none; margin: 20px 0; font-size: 0.85rem;">
            ${p.feat.map(f => `<li><i class="fas fa-check" style="color: var(--primary)"></i> ${f}</li>`).join('')}
          </ul>
          <button class="btn btn-plan" onclick="window.location.href='registro.html?plan=${p.id}'">Elegir este plan</button>
        </div>`).join('');
    }

    function startTimer() {
      let t = 900;
      setInterval(() => {
        let m = Math.floor(t/60), s = t%60;
        document.getElementById('timer').innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
        if(t > 0) t--;
      }, 1000);
    }
  </script>
</body>
</html>
