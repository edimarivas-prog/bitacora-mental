<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Mi Agenda - Bitácora Pro</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    :root { --sidebar-bg: #1F2933; --primary: #4F6F52; --bg: #F3F4F6; --text: #1F2933; --border: #E5E7EB; --success: #10B981; }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'DM Sans', sans-serif; background: var(--bg); display: flex; min-height: 100vh; }

    /* SIDEBAR */
    .sidebar { width: 260px; background: var(--sidebar-bg); color: white; padding: 24px; position: fixed; height: 100%; top: 0; display: flex; flex-direction: column; }
    .logo { font-family: 'Outfit'; font-weight: 700; color: white; font-size: 1.3rem; margin-bottom: 40px; display: flex; align-items: center; gap: 10px; text-decoration: none; }
    .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px; color: #CBD5E1; text-decoration: none; border-radius: 12px; transition: 0.2s; }
    .nav-item:hover, .nav-item.active { background: var(--primary); color: white; }
    .nav-title { font-size: 0.7rem; text-transform: uppercase; color: #94A3B8; font-weight: 700; margin: 20px 0 10px 10px; }

    /* MAIN */
    .main { flex: 1; padding: 30px 40px; margin-left: 260px; }
    
    .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
    .page-title { font-family: 'Outfit'; font-size: 1.8rem; margin: 0; }

    /* TABS */
    .tabs { display: flex; gap: 20px; border-bottom: 1px solid var(--border); margin-bottom: 30px; }
    .tab { padding: 10px 20px; cursor: pointer; border-bottom: 3px solid transparent; font-weight: 600; color: #64748B; }
    .tab.active { border-color: var(--primary); color: var(--primary); }

    /* CONTENEDORES */
    .view-section { display: none; }
    .view-section.active { display: block; }

    /* VISTA CITAS */
    .calendar-grid { display: grid; gap: 15px; }
    .appt-card { background: white; padding: 20px; border-radius: 12px; border-left: 5px solid var(--primary); box-shadow: 0 4px 10px rgba(0,0,0,0.03); display: flex; justify-content: space-between; align-items: center; }
    .date-box { text-align: center; padding-right: 20px; border-right: 1px solid var(--border); min-width: 80px; }
    .date-day { font-size: 1.2rem; font-weight: 700; color: var(--text); }
    .date-month { font-size: 0.8rem; text-transform: uppercase; color: #64748B; }
    
    .appt-info { padding-left: 20px; flex: 1; }
    .appt-time { font-weight: 700; color: var(--primary); font-family: 'Outfit'; }
    .appt-name { font-size: 1.1rem; margin: 5px 0; }
    
    .btn-action { padding: 8px 16px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; text-decoration: none; display: inline-flex; align-items: center; gap: 8px; }
    .btn-video { background: var(--success); color: white; }
    .btn-cancel { background: #FEE2E2; color: #991B1B; margin-left: 10px; }

    /* VISTA CONFIGURACIÓN */
    .config-card { background: white; padding: 30px; border-radius: 16px; max-width: 800px; }
    .day-row { display: flex; align-items: center; justify-content: space-between; padding: 15px 0; border-bottom: 1px solid #F1F5F9; }
    .day-label { font-weight: 700; width: 120px; }
    
    /* Switch */
    .switch { position: relative; display: inline-block; width: 50px; height: 26px; margin-right: 20px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
    .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: var(--primary); }
    input:checked + .slider:before { transform: translateX(24px); }

    .time-inputs { display: flex; gap: 10px; align-items: center; opacity: 0.5; pointer-events: none; transition: 0.3s; }
    .day-row.active .time-inputs { opacity: 1; pointer-events: all; }
    .input-time { padding: 8px; border: 1px solid var(--border); border-radius: 6px; font-family: inherit; }

    @media (max-width: 900px) { .sidebar { display:none; } .main { margin-left:0; padding: 20px; } .appt-card { flex-direction: column; align-items: flex-start; gap: 15px; } .date-box { border-right: none; border-bottom: 1px solid var(--border); width: 100%; padding-bottom: 10px; text-align: left; display: flex; gap: 10px; align-items: baseline; } }
  </style>
</head>
<body>

  <aside class="sidebar">
    <a href="#" class="logo"><i class="fas fa-user-md"></i> BITÁCORA PRO</a>
    <div class="nav-title">CONSULTORIO</div>
    <a href="dashboard.html" class="nav-item"><i class="fas fa-th-large"></i> Resumen</a>
    <a href="agenda.html" class="nav-item active"><i class="far fa-calendar-alt"></i> Agenda</a>
    <a href="pacientes.html" class="nav-item"><i class="fas fa-users"></i> Mis Pacientes</a>
    <div class="nav-title">GESTIÓN</div>
    <a href="billetera.html" class="nav-item"><i class="fas fa-wallet"></i> Billetera</a>
    <a href="perfil.html" class="nav-item"><i class="fas fa-id-card"></i> Mi Perfil</a>
    <div style="margin-top:auto;"><a href="#" onclick="logout()" class="nav-item" style="color:#EF4444;">Salir</a></div>
  </aside>

  <main class="main">
    <div class="page-header">
        <h1 class="page-title">Agenda Profesional</h1>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('citas')">Próximas Citas</div>
        <div class="tab" onclick="switchTab('horario')">Configurar Disponibilidad</div>
    </div>

    <div id="view-citas" class="view-section active">
        <div class="calendar-grid" id="citasContainer">
            <p style="text-align:center; color:#94A3B8; padding:50px;">
                <i class="fas fa-spinner fa-spin"></i> Cargando agenda...
            </p>
        </div>
    </div>

    <div id="view-horario" class="view-section">
        <div class="config-card">
            <h3 style="margin-bottom:20px;">Horario Semanal Estándar</h3>
            <p style="color:#64748B; font-size:0.9rem; margin-bottom:30px;">
                Define los días y horas en los que aceptas nuevas citas. Los cambios aplicarán para las futuras reservas.
            </p>

            <div id="daysContainer">
                </div>

            <button class="btn-action btn-video" style="background:var(--sidebar-bg); margin-top:20px; width:100%; justify-content:center;" onclick="saveSchedule()">
                <i class="fas fa-save"></i> Guardar Disponibilidad
            </button>
        </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="../js/supabase-config.js"></script>
  <script>
    const daysMap = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
    let mySchedule = [];

    // 1. INICIAR
    async function init() {
        if (!window.sb) return setTimeout(init, 100);
        const { data: { session } } = await window.sb.auth.getSession();
        if (!session) window.location.href = '../login.html';

        loadAppointments(session.user.id);
        loadSchedule(session.user.id);
    }
    init();

    // 2. CARGAR CITAS (VIEW 1)
    async function loadAppointments(userId) {
        // Consulta real uniendo con perfil de paciente
        const { data: citas, error } = await window.sb
            .from('citas')
            .select('*, paciente:paciente_id(nombre)')
            .eq('psicologo_id', userId)
            .gte('fecha_hora', new Date().toISOString()) // Solo futuras
            .order('fecha_hora', { ascending: true });

        const container = document.getElementById('citasContainer');

        if (!citas || citas.length === 0) {
            container.innerHTML = `
                <div style="text-align:center; padding:50px; background:white; border-radius:12px;">
                    <i class="far fa-calendar-check fa-3x" style="color:#CBD5E1; margin-bottom:20px;"></i>
                    <p style="color:#64748B;">No tienes citas programadas próximamente.</p>
                </div>`;
            return;
        }

        container.innerHTML = citas.map(c => {
            const date = new Date(c.fecha_hora);
            return `
            <div class="appt-card">
                <div class="date-box">
                    <div class="date-day">${date.getDate()}</div>
                    <div class="date-month">${date.toLocaleString('es-ES', { month: 'short' })}</div>
                </div>
                <div class="appt-info">
                    <div class="appt-time"><i class="far fa-clock"></i> ${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                    <div class="appt-name">${c.paciente?.nombre || 'Paciente'}</div>
                    <div style="font-size:0.85rem; color:#64748B;">Consulta General</div>
                </div>
                <div>
                    <a href="sesion-live.html?room=${c.link_reunion || 'Sala'+c.id}&patient=${c.paciente?.nombre}" class="btn-action btn-video">
                        <i class="fas fa-video"></i> Entrar
                    </a>
                </div>
            </div>`;
        }).join('');
    }

    // 3. CARGAR HORARIO (VIEW 2)
    async function loadSchedule(userId) {
        // Obtener configuración guardada
        const { data } = await window.sb.from('horarios_profesionales').select('*').eq('psicologo_id', userId);
        
        // Preparar estructura de 7 días
        const container = document.getElementById('daysContainer');
        let html = '';

        for (let i = 1; i <= 6; i++) { // Lunes (1) a Sábado (6) - Omitimos Domingo por defecto si quieres
            // Buscar si ya existe config para este día
            const config = data ? data.find(d => d.dia_semana === i) : null;
            const isActive = config ? config.activo : false;
            const start = config ? config.hora_inicio.substring(0,5) : '09:00';
            const end = config ? config.hora_fin.substring(0,5) : '18:00';

            html += `
            <div class="day-row ${isActive ? 'active' : ''}" id="row-${i}">
                <div class="day-label">${daysMap[i]}</div>
                <label class="switch">
                    <input type="checkbox" id="check-${i}" ${isActive ? 'checked' : ''} onchange="toggleDay(${i})">
                    <span class="slider"></span>
                </label>
                <div class="time-inputs">
                    <input type="time" class="input-time" id="start-${i}" value="${start}">
                    <span>a</span>
                    <input type="time" class="input-time" id="end-${i}" value="${end}">
                </div>
            </div>`;
        }
        container.innerHTML = html;
    }

    // 4. GUARDAR HORARIO
    async function saveSchedule() {
        const btn = document.querySelector('.btn-action');
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
        
        const { data: { user } } = await window.sb.auth.getUser();
        const updates = [];

        // Recorrer Lunes(1) a Sábado(6)
        for (let i = 1; i <= 6; i++) {
            updates.push({
                psicologo_id: user.id,
                dia_semana: i,
                activo: document.getElementById(`check-${i}`).checked,
                hora_inicio: document.getElementById(`start-${i}`).value,
                hora_fin: document.getElementById(`end-${i}`).value
            });
        }

        // Upsert (Insertar o Actualizar)
        const { error } = await window.sb.from('horarios_profesionales').upsert(updates, { onConflict: 'psicologo_id, dia_semana' });

        if (!error) {
            btn.innerHTML = '<i class="fas fa-check"></i> ¡Horario Actualizado!';
            btn.style.background = '#10B981';
            setTimeout(() => { 
                btn.innerHTML = '<i class="fas fa-save"></i> Guardar Disponibilidad'; 
                btn.style.background = '#1F2933';
            }, 2000);
        } else {
            alert("Error al guardar: " + error.message);
        }
    }

    // INTERFAZ
    function toggleDay(i) {
        const row = document.getElementById(`row-${i}`);
        const check = document.getElementById(`check-${i}`);
        if(check.checked) row.classList.add('active');
        else row.classList.remove('active');
    }

    function switchTab(tab) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
        
        event.currentTarget.classList.add('active');
        document.getElementById(`view-${tab}`).classList.add('active');
    }

    async function logout() {
        await window.sb.auth.signOut();
        window.location.href = '../login.html';
    }
  </script>
</body>
</html>
