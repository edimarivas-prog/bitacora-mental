<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Agenda Profesional - Bit치cora</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    /* --- ESTILOS MAESTROS --- */
    :root { --sidebar-bg: #1F2933; --primary: #4F6F52; --bg: #F3F4F6; --text: #1F2933; --border: #E5E7EB; --white: #FFFFFF; --danger: #EF4444; --success: #10B981; }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'DM Sans', sans-serif; background: var(--bg); color: var(--text); display: flex; min-height: 100vh; }

    /* SIDEBAR COMPLETO */
    .sidebar { width: 260px; background: var(--sidebar-bg); color: white; padding: 24px; position: fixed; height: 100%; top: 0; display: flex; flex-direction: column; z-index: 100; transition: transform 0.3s ease; }
    .logo { font-family: 'Outfit'; font-weight: 700; color: white; font-size: 1.3rem; text-decoration: none; display: flex; align-items: center; gap: 10px; margin-bottom: 40px; }
    .nav-title { font-size: 0.7rem; text-transform: uppercase; color: #94A3B8; font-weight: 700; padding-left: 12px; margin-bottom: 8px; margin-top: 20px; }
    .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px; color: #CBD5E1; text-decoration: none; border-radius: 12px; transition: 0.2s; font-size: 0.95rem; }
    .nav-item:hover, .nav-item.active { background: var(--primary); color: white; }
    
    /* MAIN */
    .main { flex: 1; padding: 30px; margin-left: 260px; height: 100vh; overflow-y: auto; }

    /* HEADER */
    .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
    .page-title { font-family: 'Outfit'; font-size: 1.8rem; margin: 0; }
    .btn-config { background: white; border: 1px solid var(--border); padding: 10px 20px; border-radius: 10px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; transition: 0.2s; }
    .btn-config:hover { border-color: var(--primary); color: var(--primary); }

    /* LAYOUT AGENDA */
    .agenda-grid { display: grid; grid-template-columns: 3fr 1fr; gap: 25px; height: calc(100vh - 120px); }

    /* CALENDARIO (Izquierda) */
    .calendar-card { background: white; border-radius: 20px; padding: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); display: flex; flex-direction: column; }
    
    .cal-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .cal-month { font-family: 'Outfit'; font-size: 1.4rem; font-weight: 700; text-transform: capitalize; }
    .btn-nav-cal { width: 36px; height: 36px; border-radius: 50%; border: 1px solid var(--border); background: white; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
    .btn-nav-cal:hover { background: var(--bg); }

    .cal-days-header { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; margin-bottom: 10px; text-align: center; font-weight: 700; color: #94A3B8; font-size: 0.8rem; }
    .cal-days-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; flex: 1; }

    /* Celdas del d칤a */
    .day-cell { border: 1px solid var(--border); border-radius: 12px; padding: 10px; min-height: 80px; cursor: pointer; transition: 0.2s; position: relative; display: flex; flex-direction: column; justify-content: space-between; }
    .day-cell:hover { border-color: var(--primary); transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
    .day-cell.empty { border: none; background: transparent; cursor: default; }
    .day-cell.selected { border: 2px solid var(--primary); background: #F0FDF4; }
    
    /* Estados visuales */
    .day-cell.workday { background: white; }
    .day-cell.workday .day-num { font-weight: 700; color: var(--text); }
    .day-cell.workday::after { content: 'Disponible'; font-size: 0.65rem; background: #DCFCE7; color: #166534; padding: 2px 6px; border-radius: 4px; align-self: flex-start; }

    .day-cell.blocked { background: #FEF2F2; opacity: 0.9; }
    .day-cell.blocked .day-num { color: var(--danger); text-decoration: line-through; }
    .day-cell.blocked::after { content: 'Bloqueado'; font-size: 0.65rem; background: #FECACA; color: #991B1B; padding: 2px 6px; border-radius: 4px; align-self: flex-start; }

    .day-cell.off { background: #F8FAFC; opacity: 0.5; cursor: not-allowed; }

    /* PANEL DETALLE (Derecha) */
    .detail-panel { background: white; border-radius: 20px; padding: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); display: flex; flex-direction: column; }
    
    .detail-date { font-family: 'Outfit'; font-size: 1.2rem; font-weight: 700; margin-bottom: 5px; color: var(--primary); text-transform: capitalize; }
    .detail-status { margin-bottom: 20px; font-size: 0.9rem; font-weight: 600; }
    
    .btn-action { width: 100%; padding: 12px; border-radius: 10px; border: none; font-weight: 700; cursor: pointer; margin-top: auto; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; }
    .btn-block { background: #FEE2E2; color: #DC2626; }
    .btn-block:hover { background: #FECACA; }
    .btn-unlock { background: #DCFCE7; color: #166534; }
    .btn-unlock:hover { background: #BBF7D0; }

    /* MODAL CONFIGURACI칍N BASE */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 200; display: none; align-items: center; justify-content: center; backdrop-filter: blur(3px); }
    .modal-card { background: white; width: 90%; max-width: 600px; padding: 30px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); max-height: 90vh; overflow-y: auto; }
    
    .config-row { display: grid; grid-template-columns: 120px 1fr 1fr; gap: 15px; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #F1F5F9; }
    .switch { position: relative; display: inline-block; width: 40px; height: 20px; margin-right: 10px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
    .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: var(--primary); }
    input:checked + .slider:before { transform: translateX(20px); }

    .time-input { padding: 8px; border: 1px solid var(--border); border-radius: 8px; width: 100%; }
    .btn-save-config { width: 100%; background: var(--sidebar-bg); color: white; padding: 15px; border-radius: 10px; border: none; font-weight: 700; cursor: pointer; margin-top: 20px; }

    @media (max-width: 900px) { .sidebar { display: none; } .main { margin-left: 0; padding: 15px; } .agenda-grid { grid-template-columns: 1fr; height: auto; } }
  </style>
</head>
<body>

  <aside class="sidebar">
    <a href="#" class="logo"><i class="fas fa-user-md"></i> BIT츼CORA PRO</a>
    
    <div class="nav-title">CONSULTORIO</div>
    <a href="dashboard.html" class="nav-item"><i class="fas fa-th-large"></i> Resumen</a>
    <a href="agenda.html" class="nav-item active"><i class="far fa-calendar-alt"></i> Mi Agenda</a>
    <a href="pacientes.html" class="nav-item"><i class="fas fa-users"></i> Mis Pacientes</a>
    
    <div class="nav-title">GESTI칍N</div>
    <a href="billetera.html" class="nav-item"><i class="fas fa-wallet"></i> Billetera</a>
    <a href="perfil.html" class="nav-item"><i class="fas fa-id-card"></i> Mi Perfil</a>
    
    <div style="margin-top:auto;">
        <a href="#" onclick="logout()" class="nav-item" style="color:var(--danger);"><i class="fas fa-sign-out-alt"></i> Salir</a>
    </div>
  </aside>

  <main class="main">
    <div class="page-header">
        <h1 class="page-title">Calendario Mensual</h1>
        <button class="btn-config" onclick="openConfigModal()">
            <i class="fas fa-sliders-h"></i> Configurar Rutina Base
        </button>
    </div>

    <div class="agenda-grid">
        <div class="calendar-card">
            <div class="cal-nav">
                <button class="btn-nav-cal" onclick="changeMonth(-1)"><i class="fas fa-chevron-left"></i></button>
                <div class="cal-month" id="monthLabel">--</div>
                <button class="btn-nav-cal" onclick="changeMonth(1)"><i class="fas fa-chevron-right"></i></button>
            </div>
            
            <div class="cal-days-header">
                <div>DOM</div><div>LUN</div><div>MAR</div><div>MI칄</div><div>JUE</div><div>VIE</div><div>S츼B</div>
            </div>
            
            <div class="cal-days-grid" id="calendarGrid">
                <p style="grid-column:1/-1; text-align:center;">Cargando calendario...</p>
            </div>
        </div>

        <div class="detail-panel">
            <div id="emptyDetail" style="text-align:center; color:#94A3B8; margin-top:50px;">
                <i class="far fa-hand-pointer fa-2x"></i><br><br>Selecciona un d칤a
            </div>

            <div id="dayDetail" style="display:none; flex-direction:column; height:100%;">
                <div class="detail-date" id="selDateLabel">--</div>
                <div class="detail-status" id="selStatus"></div>
                
                <div style="flex:1;">
                    <p style="font-size:0.9rem; color:#64748B; margin-bottom:10px;">Horario est치ndar:</p>
                    <div id="selHours" style="background:#F8FAFC; padding:10px; border-radius:10px; font-weight:500; font-size:0.9rem;">
                        --
                    </div>
                </div>

                <button id="btnToggleBlock" class="btn-action" onclick="toggleBlockDay()">
                    </button>
            </div>
        </div>
    </div>
  </main>

  <div class="modal-overlay" id="configModal">
    <div class="modal-card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 style="font-family:'Outfit'; margin:0;">Configurar Rutina Base</h2>
            <button onclick="closeConfigModal()" style="border:none; background:none; font-size:1.5rem; cursor:pointer;">&times;</button>
        </div>
        <p style="color:#64748B; font-size:0.9rem; margin-bottom:20px;">Define qu칠 d칤as trabajas normalmente y en qu칠 horario.</p>

        <div id="configRows">
            </div>

        <button class="btn-save-config" onclick="saveRoutineConfig()">
            <i class="fas fa-save"></i> Guardar Rutina
        </button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="../js/supabase-config.js"></script>
  <script>
    let currentMonth = new Date();
    let weeklyConfig = []; // Rutina base tra칤da de DB
    let blockedDates = []; // Bloqueos tra칤dos de DB
    let selectedDateStr = null; // Fecha seleccionada YYYY-MM-DD
    
    // Nombres d칤as para el modal
    const dayNames = ['Domingo', 'Lunes', 'Martes', 'Mi칠rcoles', 'Jueves', 'Viernes', 'S치bado'];

    // 1. INICIALIZAR
    async function init() {
        if (!window.sb) return setTimeout(init, 100);
        const { data: { session } } = await window.sb.auth.getSession();
        if (!session) window.location.href = '../login.html';

        await loadData(session.user.id);
        renderCalendar();
    }
    init();

    // 2. CARGAR DATOS
    async function loadData(userId) {
        // Rutina Base
        const { data: routine } = await window.sb.from('horarios_profesionales').select('*').eq('psicologo_id', userId).eq('activo', true);
        weeklyConfig = routine || [];

        // Bloqueos (Futuros y pasados recientes)
        const { data: blocks } = await window.sb.from('bloqueos_agenda').select('*').eq('psicologo_id', userId);
        blockedDates = blocks || [];
    }

    // 3. RENDERIZAR CALENDARIO
    function renderCalendar() {
        const grid = document.getElementById('calendarGrid');
        const label = document.getElementById('monthLabel');
        grid.innerHTML = '';

        const year = currentMonth.getFullYear();
        const month = currentMonth.getMonth();
        label.textContent = currentMonth.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });

        const firstDay = new Date(year, month, 1).getDay(); // 0=Dom
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        // Celdas vac칤as
        for (let i = 0; i < firstDay; i++) {
            grid.innerHTML += `<div class="day-cell empty"></div>`;
        }

        // D칤as reales
        for (let day = 1; day <= daysInMonth; day++) {
            const dateStr = `${year}-${(month+1).toString().padStart(2,'0')}-${day.toString().padStart(2,'0')}`;
            const cellDate = new Date(dateStr + 'T00:00:00'); // Forzar hora local
            
            // Determinar d칤a semana (Dom=0, Lun=1...S치b=6) - OJO: Supabase DB suele usar 1=Lun...7=Dom, ajustar seg칰n tu DB.
            // Para simplificar, usaremos el est치ndar JS (0-6) y mapearemos al guardar.
            let dayOfWeek = cellDate.getDay(); 
            // Ajuste para DB (si tu DB usa Lun=1...Dom=7)
            let dbDayOfWeek = dayOfWeek === 0 ? 7 : dayOfWeek; 

            // 쮼st치 en Rutina Base?
            const routine = weeklyConfig.find(r => r.dia_semana === dbDayOfWeek);
            const isWorkDay = !!routine;

            // 쮼st치 Bloqueado Manualmente?
            const block = blockedDates.find(b => {
                const bStart = b.fecha_inicio.split('T')[0];
                return bStart === dateStr;
            });
            const isBlocked = !!block;

            // Crear Celda
            const cell = document.createElement('div');
            cell.className = 'day-cell';
            cell.innerHTML = `<span class="day-num">${day}</span>`;

            if (isBlocked) {
                cell.classList.add('blocked');
                cell.onclick = () => selectDate(dateStr, 'blocked', routine);
            } else if (isWorkDay) {
                cell.classList.add('workday');
                cell.onclick = () => selectDate(dateStr, 'available', routine);
            } else {
                cell.classList.add('off'); // D칤a libre (ej: S치bado/Domingo)
                // Opcional: permitir click para habilitar excepci칩n de trabajo extra
            }

            if(selectedDateStr === dateStr) cell.classList.add('selected');
            grid.appendChild(cell);
        }
    }

    // 4. SELECCIONAR D칈A (Panel Derecho)
    function selectDate(dateStr, type, routine) {
        selectedDateStr = dateStr;
        
        // Actualizar UI Calendario
        document.querySelectorAll('.day-cell').forEach(c => c.classList.remove('selected'));
        // (Nota: para a침adir la clase 'selected' visualmente necesitar칤amos referencia al elemento clickeado, pero al volver a renderizar se pierde. Simplificamos repintando o buscando por texto)
        renderCalendar(); // Refresca para mostrar selecci칩n

        // Mostrar Panel Detalle
        document.getElementById('emptyDetail').style.display = 'none';
        const detail = document.getElementById('dayDetail');
        detail.style.display = 'flex';

        // Llenar Datos Panel
        const d = new Date(dateStr + 'T00:00:00');
        document.getElementById('selDateLabel').textContent = d.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });

        const statusEl = document.getElementById('selStatus');
        const hoursEl = document.getElementById('selHours');
        const btn = document.getElementById('btnToggleBlock');

        if (type === 'blocked') {
            statusEl.innerHTML = '<span style="color:#DC2626;">游댮 D칤a marcado como NO disponible</span>';
            hoursEl.innerHTML = 'Sin atenci칩n.';
            btn.className = 'btn-action btn-unlock';
            btn.innerHTML = '<i class="fas fa-check"></i> Habilitar este d칤a';
            btn.onclick = () => removeBlock(dateStr);
        } else {
            statusEl.innerHTML = '<span style="color:#166534;">游릭 D칤a Disponible</span>';
            // Mostrar horas
            if(routine && routine.franjas) {
                hoursEl.innerHTML = routine.franjas.map(f => `${f.start} - ${f.end}`).join('<br>');
            } else {
                hoursEl.innerHTML = 'Horario est치ndar';
            }
            
            btn.className = 'btn-action btn-block';
            btn.innerHTML = '<i class="fas fa-ban"></i> Bloquear este d칤a';
            btn.onclick = () => addBlock(dateStr);
        }
    }

    // 5. ACCIONES DE BLOQUEO
    async function addBlock(dateStr) {
        const { data: { user } } = await window.sb.auth.getUser();
        
        await window.sb.from('bloqueos_agenda').insert({
            psicologo_id: user.id,
            fecha_inicio: dateStr + 'T00:00:00',
            fecha_fin: dateStr + 'T23:59:59',
            motivo: 'Bloqueo manual'
        });

        // Recargar
        await loadData(user.id);
        renderCalendar();
        // Simular re-selecci칩n
        selectDate(dateStr, 'blocked', null);
    }

    async function removeBlock(dateStr) {
        const { data: { user } } = await window.sb.auth.getUser();
        
        // Buscar el ID del bloqueo
        const block = blockedDates.find(b => b.fecha_inicio.startsWith(dateStr));
        if(block) {
            await window.sb.from('bloqueos_agenda').delete().eq('id', block.id);
        }

        await loadData(user.id);
        renderCalendar();
        // Simular re-selecci칩n (recuperamos rutina original)
        const d = new Date(dateStr + 'T00:00:00');
        let dbDay = d.getDay() === 0 ? 7 : d.getDay();
        const routine = weeklyConfig.find(r => r.dia_semana === dbDay);
        selectDate(dateStr, 'available', routine);
    }

    // 6. MODAL DE RUTINA BASE (Funcionalidad Nueva)
    function openConfigModal() {
        document.getElementById('configModal').style.display = 'flex';
        renderConfigRows();
    }
    
    function closeConfigModal() {
        document.getElementById('configModal').style.display = 'none';
    }

    function renderConfigRows() {
        const container = document.getElementById('configRows');
        container.innerHTML = '';

        // Generar filas Lun(1) a Dom(7)
        // Ojo: En el array 'dayNames', Lun es index 1.
        for(let i=1; i<=7; i++) {
            // Ajuste 칤ndice array (Dom est치 al principio o final seg칰n gusto, usaremos 1=Lun...6=Sab, 7=Dom)
            // Array names: 0=Dom, 1=Lun...
            let nameIdx = i === 7 ? 0 : i; 
            
            const existing = weeklyConfig.find(w => w.dia_semana === i);
            const isActive = !!existing;
            const startT = existing?.franjas?.[0]?.start || '09:00';
            const endT = existing?.franjas?.[0]?.end || '18:00';

            container.innerHTML += `
            <div class="config-row">
                <div style="font-weight:600;">${dayNames[nameIdx]}</div>
                <div>
                    <label class="switch">
                        <input type="checkbox" id="check-${i}" ${isActive ? 'checked' : ''}>
                        <span class="slider"></span>
                    </label>
                </div>
                <div style="display:flex; gap:5px;">
                    <input type="time" class="time-input" id="start-${i}" value="${startT}">
                    <input type="time" class="time-input" id="end-${i}" value="${endT}">
                </div>
            </div>`;
        }
    }

    async function saveRoutineConfig() {
        const btn = document.querySelector('.btn-save-config');
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
        
        const { data: { user } } = await window.sb.auth.getUser();
        const newConfig = [];

        for(let i=1; i<=7; i++) {
            const isActive = document.getElementById(`check-${i}`).checked;
            if(isActive) {
                newConfig.push({
                    psicologo_id: user.id,
                    dia_semana: i,
                    activo: true,
                    franjas: [{
                        start: document.getElementById(`start-${i}`).value,
                        end: document.getElementById(`end-${i}`).value
                    }]
                });
            }
        }

        // 1. Borrar configuraci칩n vieja (Estrategia simple: borrar todo y reinsertar activos)
        // Nota: Mejor usar Upsert o borrar inactivos, pero delete/insert es m치s limpio para MVP
        await window.sb.from('horarios_profesionales').delete().eq('psicologo_id', user.id);
        
        if(newConfig.length > 0) {
            await window.sb.from('horarios_profesionales').insert(newConfig);
        }

        await loadData(user.id);
        renderCalendar();
        closeConfigModal();
        btn.innerHTML = '<i class="fas fa-save"></i> Guardar Rutina';
    }

    function changeMonth(d) {
        currentMonth.setMonth(currentMonth.getMonth() + d);
        renderCalendar();
    }
    
    async function logout() { await window.sb.auth.signOut(); window.location.href = '../login.html'; }
  </script>
</body>
</html>
