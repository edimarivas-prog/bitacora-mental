<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Mi Agenda Visual - Bit치cora Pro</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    /* --- ESTILOS BASE --- */
    :root { --sidebar-bg: #1F2933; --primary: #4F6F52; --primary-light: #E8F5E9; --bg: #F3F4F6; --text: #1F2933; --border: #E5E7EB; --danger: #EF4444; }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'DM Sans', sans-serif; background: var(--bg); display: flex; min-height: 100vh; color: var(--text); }

    /* Sidebar */
    .sidebar { width: 260px; background: var(--sidebar-bg); color: white; padding: 24px; position: fixed; height: 100%; top: 0; display: flex; flex-direction: column; z-index: 10; }
    .main { flex: 1; padding: 30px; margin-left: 260px; height: 100vh; overflow-y: auto; }
    .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px; color: #CBD5E1; text-decoration: none; border-radius: 12px; transition: 0.2s; }
    .nav-item:hover, .nav-item.active { background: var(--primary); color: white; }
    .logo { font-family: 'Outfit'; font-weight: 700; color: white; font-size: 1.3rem; margin-bottom: 40px; display: block; text-decoration: none; }

    /* --- LAYOUT DE AGENDA VISUAL --- */
    .agenda-container { display: grid; grid-template-columns: 2fr 1fr; gap: 30px; height: calc(100vh - 100px); }
    
    /* Panel Izquierdo: CALENDARIO */
    .calendar-card { background: white; border-radius: 20px; padding: 25px; box-shadow: 0 4px 20px rgba(0,0,0,0.03); display: flex; flex-direction: column; }
    
    .cal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .cal-month-title { font-family: 'Outfit'; font-size: 1.5rem; font-weight: 700; text-transform: capitalize; }
    .btn-nav { background: #F1F5F9; border: none; width: 40px; height: 40px; border-radius: 10px; cursor: pointer; transition: 0.2s; color: var(--text); }
    .btn-nav:hover { background: var(--primary); color: white; }

    .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; flex: 1; }
    .day-label { text-align: center; color: #94A3B8; font-weight: 700; font-size: 0.8rem; margin-bottom: 10px; text-transform: uppercase; }
    
    /* Celdas del Calendario */
    .day-cell { 
        border: 1px solid var(--border); border-radius: 12px; padding: 10px; 
        cursor: pointer; position: relative; transition: 0.2s; display: flex; flex-direction: column; justify-content: space-between;
        min-height: 80px;
    }
    .day-cell:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.05); border-color: var(--primary); }
    .day-cell.empty { background: transparent; border: none; cursor: default; }
    .day-cell.selected { border: 2px solid var(--primary); background: var(--primary-light); }
    
    /* Estados del D칤a */
    .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 5px; }
    .day-cell.available { background: white; }
    .day-cell.available .day-number { color: var(--text); font-weight: 700; }
    .day-cell.available::after { content: 'Disponible'; font-size: 0.7rem; color: #166534; background: #DCFCE7; padding: 2px 6px; border-radius: 4px; margin-top: auto; align-self: flex-start; }
    
    .day-cell.blocked { background: #F9FAFB; opacity: 0.8; }
    .day-cell.blocked .day-number { color: #94A3B8; text-decoration: line-through; }
    .day-cell.blocked::after { content: 'Bloqueado'; font-size: 0.7rem; color: #991B1B; background: #FEE2E2; padding: 2px 6px; border-radius: 4px; margin-top: auto; align-self: flex-start; }

    /* Panel Derecho: DETALLE DEL D칈A */
    .detail-card { background: white; border-radius: 20px; padding: 25px; box-shadow: 0 4px 20px rgba(0,0,0,0.03); display: flex; flex-direction: column; }
    
    .detail-header { border-bottom: 1px solid var(--border); padding-bottom: 15px; margin-bottom: 20px; }
    .detail-date { font-family: 'Outfit'; font-size: 1.5rem; color: var(--primary); margin-bottom: 5px; text-transform: capitalize; }
    .detail-status { font-size: 0.9rem; font-weight: 600; display: inline-flex; align-items: center; gap: 6px; }
    
    .slots-list { flex: 1; overflow-y: auto; }
    .slot-item { background: #F8FAFC; padding: 12px; border-radius: 10px; border: 1px solid var(--border); margin-bottom: 10px; display: flex; align-items: center; gap: 10px; font-weight: 500; }
    
    /* Botones de Acci칩n */
    .action-area { margin-top: auto; padding-top: 20px; border-top: 1px solid var(--border); }
    .btn-toggle-block { width: 100%; padding: 15px; border-radius: 12px; border: none; font-weight: 700; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 1rem; }
    
    .btn-block-day { background: #FEE2E2; color: #DC2626; }
    .btn-block-day:hover { background: #FECACA; }
    
    .btn-unblock-day { background: #DCFCE7; color: #166534; }
    .btn-unblock-day:hover { background: #BBF7D0; }

    .btn-edit-base { background: transparent; border: 1px solid var(--text-soft); color: var(--text-soft); padding: 8px 15px; border-radius: 8px; font-size: 0.85rem; cursor: pointer; margin-top: 10px; width: 100%; }

    /* Modal Simple para editar base */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; align-items: center; justify-content: center; }
    .modal.active { display: flex; }
    .modal-content { background: white; padding: 30px; border-radius: 20px; width: 90%; max-width: 500px; }

    @media(max-width: 1000px) { .agenda-container { grid-template-columns: 1fr; } .sidebar { display: none; } .main { margin-left: 0; padding: 20px; height: auto; } }
  </style>
</head>
<body>

  <aside class="sidebar">
    <a href="#" class="logo"><i class="fas fa-user-md"></i> BIT츼CORA PRO</a>
    <a href="dashboard.html" class="nav-item"><i class="fas fa-th-large"></i> Resumen</a>
    <a href="agenda.html" class="nav-item active"><i class="far fa-calendar-alt"></i> Mi Agenda</a>
    <a href="pacientes.html" class="nav-item"><i class="fas fa-users"></i> Mis Pacientes</a>
    <div style="margin-top:auto;"><a href="#" onclick="logout()" class="nav-item" style="color:#EF4444;">Salir</a></div>
  </aside>

  <main class="main">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h1 style="font-family:'Outfit'; margin:0;">Calendario de Disponibilidad</h1>
        <button class="btn-edit-base" onclick="alert('Aqu칤 podr칤as editar tu rutina Lunes-Viernes general')"><i class="fas fa-cog"></i> Configurar Rutina Base</button>
    </div>

    <div class="agenda-container">
        
        <div class="calendar-card">
            <div class="cal-header">
                <button class="btn-nav" onclick="changeMonth(-1)"><i class="fas fa-chevron-left"></i></button>
                <div class="cal-month-title" id="monthLabel">--</div>
                <button class="btn-nav" onclick="changeMonth(1)"><i class="fas fa-chevron-right"></i></button>
            </div>
            
            <div style="display:grid; grid-template-columns: repeat(7, 1fr); gap:10px; margin-bottom:10px;">
                <div class="day-label">Dom</div><div class="day-label">Lun</div><div class="day-label">Mar</div>
                <div class="day-label">Mi칠</div><div class="day-label">Jue</div><div class="day-label">Vie</div>
                <div class="day-label">S치b</div>
            </div>

            <div class="cal-grid" id="calendarGrid">
                </div>
        </div>

        <div class="detail-card">
            <div id="loadingDetail" style="text-align:center; padding:50px; color:#94A3B8;">
                <i class="fas fa-mouse-pointer"></i><br>Selecciona un d칤a en el calendario
            </div>

            <div id="dayDetail" style="display:none; flex-direction:column; height:100%;">
                <div class="detail-header">
                    <h2 class="detail-date" id="selectedDateLabel">--</h2>
                    <div id="statusBadge"></div>
                </div>

                <h4 style="margin-bottom:15px; color:#64748B;">Horarios para este d칤a:</h4>
                <div class="slots-list" id="slotsContainer">
                    </div>

                <div class="action-area">
                    <button id="btnToggleBlock" class="btn-toggle-block" onclick="toggleDateBlock()">
                        </button>
                    <p style="font-size:0.8rem; color:#94A3B8; text-align:center; margin-top:10px;">
                        Esto bloquear치/desbloquear치 solo este d칤a espec칤fico.
                    </p>
                </div>
            </div>
        </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="../js/supabase-config.js"></script>
  <script>
    let currentMonth = new Date();
    let weeklyConfig = []; // Rutina base (Lunes si, Martes no...)
    let blockedDates = []; // Excepciones (Fechas espec칤ficas bloqueadas)
    let selectedDateStr = null; // Fecha seleccionada actualmente YYYY-MM-DD

    // 1. INICIAR
    async function init() {
        if (!window.sb) return setTimeout(init, 100);
        const { data: { session } } = await window.sb.auth.getSession();
        if (!session) window.location.href = '../login.html';

        await loadData(session.user.id);
        renderCalendar();
    }
    init();

    // 2. CARGAR DATOS (Rutina Base + Bloqueos)
    async function loadData(userId) {
        // A. Rutina Semanal (Lunes=1 ... Domingo=7)
        const { data: schedule } = await window.sb
            .from('horarios_profesionales')
            .select('*')
            .eq('psicologo_id', userId)
            .eq('activo', true);
        weeklyConfig = schedule || [];

        // B. Bloqueos de Fechas Espec칤ficas
        // Truco: Traemos los bloqueos del mes actual +/- 1 mes para no cargar todo el historial
        const { data: blocks } = await window.sb
            .from('bloqueos_agenda')
            .select('*')
            .eq('psicologo_id', userId);
        blockedDates = blocks || [];
    }

    // 3. RENDERIZAR CALENDARIO
    function renderCalendar() {
        const grid = document.getElementById('calendarGrid');
        const label = document.getElementById('monthLabel');
        grid.innerHTML = '';

        const year = currentMonth.getFullYear();
        const month = currentMonth.getMonth();
        label.textContent = currentMonth.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });

        const firstDay = new Date(year, month, 1).getDay(); // 0=Dom
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        // Celdas vac칤as
        for (let i = 0; i < firstDay; i++) {
            grid.innerHTML += `<div class="day-cell empty"></div>`;
        }

        // D칤as
        for (let day = 1; day <= daysInMonth; day++) {
            const dateStr = `${year}-${(month+1).toString().padStart(2,'0')}-${day.toString().padStart(2,'0')}`;
            const cellDate = new Date(dateStr + 'T00:00:00'); // Forzar local

            // Determinar estado
            // 1. 쮼st치 bloqueado manualmente?
            const isBlocked = blockedDates.some(b => {
                const start = b.fecha_inicio.split('T')[0];
                const end = b.fecha_fin.split('T')[0];
                return dateStr >= start && dateStr <= end;
            });

            // 2. 쮼s d칤a laboral seg칰n rutina base?
            // JS getDay(): Dom=0, Lun=1. DB: Lun=1...Dom=7 (Ajuste necesario si tu DB es ISO)
            let dayOfWeek = cellDate.getDay(); 
            if(dayOfWeek === 0) dayOfWeek = 7; // Ajuste para DB

            const config = weeklyConfig.find(w => w.dia_semana === dayOfWeek);
            const isWorkDay = config ? true : false;

            // Decidir clase CSS
            let cssClass = 'day-cell';
            if (isBlocked) {
                cssClass += ' blocked';
            } else if (isWorkDay) {
                cssClass += ' available';
            } else {
                cssClass += ' empty'; // No trabaja este d칤a de la semana
            }

            // Crear Celda
            const cell = document.createElement('div');
            cell.className = cssClass;
            cell.innerHTML = `<span class="day-number">${day}</span>`;
            
            if (isWorkDay || isBlocked) {
                cell.onclick = () => selectDate(dateStr, isBlocked, config, cell);
            } else {
                cell.style.opacity = '0.3';
                cell.style.cursor = 'default';
            }

            if(selectedDateStr === dateStr) cell.classList.add('selected');

            grid.appendChild(cell);
        }
    }

    // 4. SELECCIONAR D칈A (Panel Derecho)
    function selectDate(dateStr, isBlocked, config, cellElement) {
        selectedDateStr = dateStr;
        
        // Visual Select
        document.querySelectorAll('.day-cell').forEach(c => c.classList.remove('selected'));
        if(cellElement) cellElement.classList.add('selected');

        document.getElementById('loadingDetail').style.display = 'none';
        document.getElementById('dayDetail').style.display = 'flex';

        // Render Panel
        const dateObj = new Date(dateStr + 'T00:00:00');
        document.getElementById('selectedDateLabel').textContent = dateObj.toLocaleDateString('es-ES', {weekday: 'long', day:'numeric', month:'long'});

        const badge = document.getElementById('statusBadge');
        const slotsDiv = document.getElementById('slotsContainer');
        const btn = document.getElementById('btnToggleBlock');

        if (isBlocked) {
            // ESTADO: BLOQUEADO
            badge.innerHTML = '<span style="color:#DC2626; background:#FEE2E2; padding:5px 10px; border-radius:10px;">游댮 No disponible</span>';
            slotsDiv.innerHTML = '<p style="color:#94A3B8; font-style:italic;">Has marcado este d칤a como no laborable.</p>';
            
            btn.className = 'btn-toggle-block btn-unblock-day';
            btn.innerHTML = '<i class="fas fa-check"></i> Habilitar este d칤a';
        } else {
            // ESTADO: DISPONIBLE
            badge.innerHTML = '<span style="color:#166534; background:#DCFCE7; padding:5px 10px; border-radius:10px;">游릭 Disponible</span>';
            
            // Mostrar horas de la rutina base
            if(config && config.franjas) {
                slotsDiv.innerHTML = config.franjas.map(f => `
                    <div class="slot-item">
                        <i class="far fa-clock" style="color:var(--primary)"></i>
                        ${f.start} - ${f.end}
                    </div>
                `).join('');
            } else {
                slotsDiv.innerHTML = '<p>Sin horarios configurados.</p>';
            }

            btn.className = 'btn-toggle-block btn-block-day';
            btn.innerHTML = '<i class="fas fa-ban"></i> Bloquear este d칤a';
        }
    }

    // 5. ACCI칍N: BLOQUEAR / DESBLOQUEAR
    async function toggleDateBlock() {
        if(!selectedDateStr) return;
        const btn = document.getElementById('btnToggleBlock');
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';

        const { data: { user } } = await window.sb.auth.getUser();

        // Buscar si ya est치 bloqueado
        const existingBlock = blockedDates.find(b => {
            const start = b.fecha_inicio.split('T')[0];
            return start === selectedDateStr;
        });

        if (existingBlock) {
            // DESBLOQUEAR (Borrar de DB)
            await window.sb.from('bloqueos_agenda').delete().eq('id', existingBlock.id);
        } else {
            // BLOQUEAR (Insertar en DB)
            await window.sb.from('bloqueos_agenda').insert({
                psicologo_id: user.id,
                fecha_inicio: selectedDateStr + 'T00:00:00',
                fecha_fin: selectedDateStr + 'T23:59:59',
                motivo: 'Bloqueo manual desde calendario'
            });
        }

        // Recargar y refrescar UI
        await loadData(user.id);
        renderCalendar();
        
        // Simular click de nuevo para actualizar panel derecho
        const day = new Date(selectedDateStr + 'T00:00:00').getDay() || 7;
        const config = weeklyConfig.find(w => w.dia_semana === day);
        const isBlocked = !existingBlock; // Invertimos l칩gica porque acabamos de cambiarlo
        
        selectDate(selectedDateStr, isBlocked, config, null);
    }

    function changeMonth(delta) {
        currentMonth.setMonth(currentMonth.getMonth() + delta);
        renderCalendar();
    }

    async function logout() {
        await window.sb.auth.signOut();
        window.location.href = '../login.html';
    }
  </script>
</body>
</html>
