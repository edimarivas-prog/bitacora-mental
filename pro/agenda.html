<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Agenda Profesional - Bit치cora</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    /* --- ESTILOS MAESTROS --- */
    :root { --sidebar-bg: #1F2933; --primary: #4F6F52; --bg: #F3F4F6; --text: #1F2933; --border: #E5E7EB; --white: #FFFFFF; --danger: #EF4444; }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'DM Sans', sans-serif; background: var(--bg); color: var(--text); display: flex; min-height: 100vh; }

    /* SIDEBAR */
    .sidebar { width: 260px; background: var(--sidebar-bg); color: white; padding: 24px; position: fixed; height: 100%; top: 0; display: flex; flex-direction: column; z-index: 100; }
    .logo { font-family: 'Outfit'; font-weight: 700; color: white; font-size: 1.3rem; margin-bottom: 40px; display: flex; align-items: center; gap: 10px; text-decoration: none; }
    .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px; color: #CBD5E1; text-decoration: none; border-radius: 12px; transition: 0.2s; margin-bottom: 5px; }
    .nav-item:hover, .nav-item.active { background: var(--primary); color: white; }
    
    /* MAIN */
    .main { flex: 1; padding: 30px; margin-left: 260px; height: 100vh; overflow-y: auto; }

    /* HEADER */
    .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
    .page-title { font-family: 'Outfit'; font-size: 1.8rem; margin: 0; }
    
    .actions-group { display: flex; gap: 10px; }
    .btn-config { background: white; border: 1px solid var(--border); padding: 10px 20px; border-radius: 10px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; transition: 0.2s; }
    .btn-config:hover { border-color: var(--primary); color: var(--primary); }
    .btn-block-range { background: #FEE2E2; color: #991B1B; border: 1px solid #FECACA; padding: 10px 20px; border-radius: 10px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; }
    .btn-block-range:hover { background: #FECACA; }

    /* LAYOUT AGENDA */
    .agenda-grid { display: grid; grid-template-columns: 3fr 1fr; gap: 25px; }

    /* CALENDARIO */
    .calendar-card { background: white; border-radius: 20px; padding: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); }
    .cal-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .cal-month { font-family: 'Outfit'; font-size: 1.4rem; font-weight: 700; text-transform: capitalize; }
    .btn-nav-cal { width: 36px; height: 36px; border-radius: 50%; border: 1px solid var(--border); background: white; cursor: pointer; }

    .cal-days-header { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; margin-bottom: 10px; text-align: center; font-weight: 700; color: #94A3B8; font-size: 0.8rem; }
    .cal-days-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; }

    .day-cell { border: 1px solid var(--border); border-radius: 12px; padding: 10px; min-height: 80px; cursor: pointer; display: flex; flex-direction: column; justify-content: space-between; transition: 0.2s; position: relative; }
    .day-cell:hover { border-color: var(--primary); transform: translateY(-2px); }
    .day-cell.empty { border: none; background: transparent; cursor: default; }
    
    .day-cell.workday { background: white; }
    .day-cell.workday::after { content: 'Disponible'; font-size: 0.65rem; background: #DCFCE7; color: #166534; padding: 2px 6px; border-radius: 4px; align-self: flex-start; }
    
    .day-cell.blocked { background: #FEF2F2; opacity: 1; border-color: #FECACA; }
    .day-cell.blocked .day-num { color: var(--danger); text-decoration: line-through; }
    .day-cell.blocked::after { content: 'Bloqueado'; font-size: 0.65rem; background: #FECACA; color: #991B1B; padding: 2px 6px; border-radius: 4px; align-self: flex-start; }

    .day-cell.selected { border: 2px solid var(--primary); box-shadow: 0 0 0 3px rgba(79, 111, 82, 0.1); }

    /* PANEL DETALLE */
    .detail-panel { background: white; border-radius: 20px; padding: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); display: flex; flex-direction: column; height: fit-content; }
    .detail-date { font-family: 'Outfit'; font-size: 1.2rem; font-weight: 700; margin-bottom: 5px; color: var(--primary); text-transform: capitalize; }
    .btn-action { width: 100%; padding: 12px; border-radius: 10px; border: none; font-weight: 700; cursor: pointer; margin-top: 20px; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .btn-block { background: #FEE2E2; color: #DC2626; }
    .btn-unlock { background: #DCFCE7; color: #166534; }

    /* MODALES */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 200; display: none; align-items: center; justify-content: center; backdrop-filter: blur(3px); }
    .modal-card { background: white; width: 90%; max-width: 500px; padding: 30px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
    .input-group { margin-bottom: 15px; }
    .input-label { display: block; font-size: 0.9rem; font-weight: 700; margin-bottom: 5px; }
    .time-input { padding: 10px; border: 1px solid var(--border); border-radius: 8px; width: 100%; font-family: inherit; }
    
    .config-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #F1F5F9; }

    @media (max-width: 900px) { .sidebar { display: none; } .main { margin-left: 0; padding: 15px; } .agenda-grid { grid-template-columns: 1fr; } }
  </style>
</head>
<body>

  <aside class="sidebar">
    <a href="#" class="logo"><i class="fas fa-user-md"></i> BIT츼CORA PRO</a>
    <a href="dashboard.html" class="nav-item"><i class="fas fa-th-large"></i> Resumen</a>
    <a href="agenda.html" class="nav-item active"><i class="far fa-calendar-alt"></i> Mi Agenda</a>
    <a href="pacientes.html" class="nav-item"><i class="fas fa-users"></i> Mis Pacientes</a>
    <div style="margin-top:auto;"><a href="#" onclick="logout()" class="nav-item" style="color:#EF4444;">Salir</a></div>
  </aside>

  <main class="main">
    <div class="page-header">
        <h1 class="page-title">Mi Agenda</h1>
        <div class="actions-group">
            <button class="btn-block-range" onclick="openBlockModal()">
                <i class="fas fa-ban"></i> Bloquear Periodo
            </button>
            <button class="btn-config" onclick="openConfigModal()">
                <i class="fas fa-sliders-h"></i> Rutina Base
            </button>
        </div>
    </div>

    <div class="agenda-grid">
        <div class="calendar-card">
            <div class="cal-nav">
                <button class="btn-nav-cal" onclick="changeMonth(-1)"><i class="fas fa-chevron-left"></i></button>
                <div class="cal-month" id="monthLabel">--</div>
                <button class="btn-nav-cal" onclick="changeMonth(1)"><i class="fas fa-chevron-right"></i></button>
            </div>
            <div class="cal-days-header">
                <div>DOM</div><div>LUN</div><div>MAR</div><div>MI칄</div><div>JUE</div><div>VIE</div><div>S츼B</div>
            </div>
            <div class="cal-days-grid" id="calendarGrid">
                <p style="grid-column:1/-1; text-align:center;">Cargando...</p>
            </div>
        </div>

        <div class="detail-panel">
            <div id="emptyDetail" style="text-align:center; color:#94A3B8; margin-top:20px;">
                <i class="far fa-hand-pointer fa-2x"></i><br><br>Selecciona un d칤a para ver detalles
            </div>
            <div id="dayDetail" style="display:none; flex-direction:column;">
                <div class="detail-date" id="selDateLabel">--</div>
                <div id="selStatus" style="margin-bottom:15px; font-weight:600;"></div>
                <div style="background:#F8FAFC; padding:15px; border-radius:10px;">
                    <small style="color:#64748B;">Horarios:</small>
                    <div id="selHours" style="font-weight:500;">--</div>
                </div>
                <button id="btnToggleBlock" class="btn-action" onclick="toggleBlockDay()"></button>
            </div>
        </div>
    </div>
  </main>

  <div class="modal-overlay" id="configModal">
    <div class="modal-card">
        <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
            <h2>Configurar Rutina</h2>
            <button onclick="document.getElementById('configModal').style.display='none'" style="border:none; bg:none; cursor:pointer; font-size:1.5rem;">&times;</button>
        </div>
        <p style="font-size:0.9rem; color:#64748B; margin-bottom:15px;">Define tus d칤as laborables est치ndar (Lunes a Domingo).</p>
        <div id="configRows"></div>
        <button class="btn-action" style="background:var(--sidebar-bg); color:white; margin-top:20px;" onclick="saveRoutineConfig()">Guardar Rutina</button>
    </div>
  </div>

  <div class="modal-overlay" id="blockModal">
    <div class="modal-card">
        <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
            <h2 style="color:var(--danger);">Bloquear Periodo</h2>
            <button onclick="document.getElementById('blockModal').style.display='none'" style="border:none; bg:none; cursor:pointer; font-size:1.5rem;">&times;</button>
        </div>
        <p style="font-size:0.9rem; color:#64748B; margin-bottom:15px;">Selecciona un rango de fechas para marcar como "No Disponible" (vacaciones, licencias).</p>
        
        <div class="input-group">
            <label class="input-label">Desde:</label>
            <input type="date" id="rangeStart" class="time-input">
        </div>
        <div class="input-group">
            <label class="input-label">Hasta:</label>
            <input type="date" id="rangeEnd" class="time-input">
        </div>

        <button class="btn-action" style="background:var(--danger); color:white; margin-top:20px;" onclick="saveBlockRange()">
            <i class="fas fa-ban"></i> Confirmar Bloqueo
        </button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="../js/supabase-config.js"></script>
  <script>
    let currentMonth = new Date();
    let weeklyConfig = []; 
    let blockedDates = []; 
    let selectedDateStr = null;
    const dayNames = ['Domingo', 'Lunes', 'Martes', 'Mi칠rcoles', 'Jueves', 'Viernes', 'S치bado'];

    async function init() {
        if (!window.sb) return setTimeout(init, 100);
        const { data: { session } } = await window.sb.auth.getSession();
        if (!session) window.location.href = '../login.html';
        await loadData(session.user.id);
        renderCalendar();
    }
    init();

    async function loadData(userId) {
        const { data: routine } = await window.sb.from('horarios_profesionales').select('*').eq('psicologo_id', userId).eq('activo', true);
        weeklyConfig = routine || [];

        // Traer bloqueos futuros y recientes
        const today = new Date();
        today.setMonth(today.getMonth() - 1);
        const { data: blocks } = await window.sb.from('bloqueos_agenda').select('*').eq('psicologo_id', userId).gte('fecha_fin', today.toISOString());
        blockedDates = blocks || [];
    }

    // --- CALENDARIO ---
    function renderCalendar() {
        const grid = document.getElementById('calendarGrid');
        const label = document.getElementById('monthLabel');
        grid.innerHTML = '';
        label.textContent = currentMonth.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });

        const year = currentMonth.getFullYear();
        const month = currentMonth.getMonth();
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        for (let i = 0; i < firstDay; i++) grid.innerHTML += `<div class="day-cell empty"></div>`;

        for (let day = 1; day <= daysInMonth; day++) {
            const dateStr = `${year}-${(month+1).toString().padStart(2,'0')}-${day.toString().padStart(2,'0')}`;
            const cellDate = new Date(dateStr + 'T00:00:00');
            
            // L칩gica Estado
            let dbDay = cellDate.getDay(); if(dbDay===0) dbDay=7; // Ajuste lun=1
            const routine = weeklyConfig.find(r => r.dia_semana === dbDay);
            
            // Check Bloqueo (Rango)
            const isBlocked = blockedDates.some(b => {
                const start = b.fecha_inicio.split('T')[0];
                const end = b.fecha_fin.split('T')[0];
                return dateStr >= start && dateStr <= end;
            });

            const cell = document.createElement('div');
            cell.className = 'day-cell';
            cell.innerHTML = `<span class="day-num">${day}</span>`;

            if (isBlocked) {
                cell.classList.add('blocked');
                cell.onclick = () => selectDate(dateStr, 'blocked', null);
            } else if (routine) {
                cell.classList.add('workday');
                cell.onclick = () => selectDate(dateStr, 'available', routine);
            } else {
                cell.classList.add('off');
            }

            if(selectedDateStr === dateStr) cell.classList.add('selected');
            grid.appendChild(cell);
        }
    }

    function selectDate(dateStr, status, routine) {
        selectedDateStr = dateStr;
        renderCalendar(); // Refresh selection visual
        
        document.getElementById('emptyDetail').style.display = 'none';
        document.getElementById('dayDetail').style.display = 'flex';
        
        const d = new Date(dateStr + 'T00:00:00');
        document.getElementById('selDateLabel').textContent = d.toLocaleDateString('es-ES', {weekday:'long', day:'numeric', month:'long'});
        
        const statusEl = document.getElementById('selStatus');
        const btn = document.getElementById('btnToggleBlock');
        const hoursEl = document.getElementById('selHours');

        if(status === 'blocked') {
            statusEl.innerHTML = '<span style="color:var(--danger)">游댮 Bloqueado</span>';
            hoursEl.textContent = 'No disponible.';
            btn.className = 'btn-action btn-unlock';
            btn.innerHTML = 'Desbloquear d칤a';
            btn.onclick = () => removeBlock(dateStr);
        } else {
            statusEl.innerHTML = '<span style="color:var(--success)">游릭 Disponible</span>';
            hoursEl.textContent = routine?.franjas?.map(f => `${f.start} - ${f.end}`).join(', ') || 'Horario base';
            btn.className = 'btn-action btn-block';
            btn.innerHTML = 'Bloquear d칤a';
            btn.onclick = () => addBlockSingle(dateStr);
        }
    }

    // --- ACCIONES BLOQUEO ---
    async function addBlockSingle(dateStr) {
        const { data: { user } } = await window.sb.auth.getUser();
        await window.sb.from('bloqueos_agenda').insert({
            psicologo_id: user.id, fecha_inicio: dateStr+'T00:00:00', fecha_fin: dateStr+'T23:59:59', motivo: 'Manual'
        });
        await loadData(user.id); renderCalendar();
        selectDate(dateStr, 'blocked', null);
    }

    async function removeBlock(dateStr) {
        const { data: { user } } = await window.sb.auth.getUser();
        // Borrar cualquier bloqueo que incluya esta fecha
        const blocks = blockedDates.filter(b => {
             const start = b.fecha_inicio.split('T')[0];
             const end = b.fecha_fin.split('T')[0];
             return dateStr >= start && dateStr <= end;
        });
        
        for(let b of blocks) {
             await window.sb.from('bloqueos_agenda').delete().eq('id', b.id);
        }
        await loadData(user.id); renderCalendar();
        // Reset view
        document.getElementById('dayDetail').style.display = 'none';
        document.getElementById('emptyDetail').style.display = 'block';
    }

    // --- BLOQUEO POR RANGO (NUEVO) ---
    function openBlockModal() { document.getElementById('blockModal').style.display = 'flex'; }
    
    async function saveBlockRange() {
        const start = document.getElementById('rangeStart').value;
        const end = document.getElementById('rangeEnd').value;
        if(!start || !end) return alert("Fechas requeridas");
        if(start > end) return alert("Fecha inicio mayor a fin");

        const { data: { user } } = await window.sb.auth.getUser();
        await window.sb.from('bloqueos_agenda').insert({
            psicologo_id: user.id,
            fecha_inicio: start + 'T00:00:00',
            fecha_fin: end + 'T23:59:59',
            motivo: 'Bloqueo por rango'
        });
        
        document.getElementById('blockModal').style.display = 'none';
        await loadData(user.id);
        renderCalendar();
        alert("Periodo bloqueado correctamente.");
    }

    // --- RUTINA BASE ---
    function openConfigModal() {
        document.getElementById('configModal').style.display = 'flex';
        const container = document.getElementById('configRows');
        container.innerHTML = '';
        
        for(let i=1; i<=7; i++) {
            // DB: 1=Lun...7=Dom -> Array DayNames: 0=Dom, 1=Lun
            let nameIdx = i === 7 ? 0 : i; 
            const existing = weeklyConfig.find(w => w.dia_semana === i);
            const isActive = !!existing;
            
            container.innerHTML += `
            <div class="config-row">
                <div style="font-weight:600;">${dayNames[nameIdx]}</div>
                <input type="checkbox" id="chk-${i}" ${isActive ? 'checked' : ''} style="width:20px; height:20px;">
                <div style="display:flex; gap:5px;">
                    <input type="time" class="time-input" id="start-${i}" value="${existing?.franjas?.[0]?.start || '09:00'}">
                    <input type="time" class="time-input" id="end-${i}" value="${existing?.franjas?.[0]?.end || '18:00'}">
                </div>
            </div>`;
        }
    }

    async function saveRoutineConfig() {
        const { data: { user } } = await window.sb.auth.getUser();
        const newConfig = [];
        
        for(let i=1; i<=7; i++) {
            if(document.getElementById(`chk-${i}`).checked) {
                newConfig.push({
                    psicologo_id: user.id, dia_semana: i, activo: true,
                    franjas: [{ start: document.getElementById(`start-${i}`).value, end: document.getElementById(`end-${i}`).value }]
                });
            }
        }
        
        // Upsert simplificado: Borrar todo y crear nuevo
        await window.sb.from('horarios_profesionales').delete().eq('psicologo_id', user.id);
        if(newConfig.length > 0) await window.sb.from('horarios_profesionales').insert(newConfig);
        
        document.getElementById('configModal').style.display = 'none';
        await loadData(user.id);
        renderCalendar();
    }

    function changeMonth(d) { currentMonth.setMonth(currentMonth.getMonth() + d); renderCalendar(); }
    async function logout() { await window.sb.auth.signOut(); window.location.href = '../login.html'; }
  </script>
</body>
</html>
